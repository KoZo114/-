<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¡œèˆã†ç©ºã‚­ãƒ£ãƒƒãƒã‚²ãƒ¼ãƒ  - ç©¶æ¥µç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');

    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
      background: linear-gradient(135deg,
        #ffeef5 0%, #ffe8f0 25%, #f8e8ff 50%, #e8f0ff 75%, #f0f8ff 100%
      );
      font-family: 'Noto Sans JP', sans-serif;
      touch-action: manipulation;
      -webkit-overflow-scrolling: touch;
    }

    /* (çœç•¥ã•ã‚ŒãŸCSSã‚¹ã‚¿ã‚¤ãƒ« ... ã”æç¤ºã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¦ãã ã•ã„) */
    /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«èƒŒæ™¯åŠ¹æœ */
    .bg-particle {
      position: absolute;
      background: rgba(255, 182, 193, 0.3);
      border-radius: 50%;
      pointer-events: none;
      animation: float-bg linear infinite;
      z-index: 0;
    }

    @keyframes float-bg {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
    }

    #character {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      max-height: 25vh; /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®é«˜ã•ã«åˆã‚ã›ã¦èª¿æ•´ */
      max-width: 120px;  /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å¹…ã«åˆã‚ã›ã¦èª¿æ•´ */
      height: auto;      /* ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¤ */
      z-index: 5;
      filter: drop-shadow(2px 4px 8px rgba(0,0,0,0.2));
      transition: all 0.3s ease;
    }

    #character.jump {
      animation: jump 0.6s ease;
    }

    #character.powerup {
      filter: drop-shadow(0 0 15px #FFD700) drop-shadow(2px 4px 8px rgba(0,0,0,0.2));
      transform: translateX(-50%) scale(1.1);
    }

    @keyframes jump {
      0%   { transform: translateX(-50%) translateY(0); }
      30%  { transform: translateX(-50%) translateY(-60px); }
      60%  { transform: translateX(-50%) translateY(-60px); }
      100% { transform: translateX(-50%) translateY(0); }
    }

    /* æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ— */
    .petal {
      position: absolute;
      width: 35px;
      height: 35px;
      background: radial-gradient(ellipse at center,
        #ffb3d9 0%, #ffc9e0 40%, #ffe0f0 80%, rgba(255, 192, 224, 0.8) 100%
      );
      border-radius: 50% 10% 50% 10%;
      box-shadow:
        0 2px 4px rgba(255, 105, 180, 0.3),
        inset 0 1px 2px rgba(255, 255, 255, 0.5);
      pointer-events: none;
      animation: fall linear;
      z-index: 1;
      filter: drop-shadow(0 0 3px rgba(255, 182, 193, 0.6));
    }

    .petal.special {
      width: 40px;
      height: 40px;
      background: radial-gradient(circle, #FFD700 0%, #FFA500 50%, #FF69B4 100%);
      filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
      animation: fall-special linear;
    }

    .petal.golden {
      width: 45px;
      height: 45px;
      background: radial-gradient(circle, #FFD700 0%, #FFFF00 30%, #FFA500 70%, #FF4500 100%);
      filter: drop-shadow(0 0 15px rgba(255, 215, 0, 1)) drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
      animation: fall-golden linear;
      border: 2px solid rgba(255, 255, 255, 0.8);
    }

    .bomb {
      position: absolute; /* JavaScriptã§å‹•ã‹ã™ãŸã‚ */
      width: 40px;
      height: 40px;
      background: radial-gradient(circle, #FF0000 0%, #8B0000 70%, #000000 100%);
      border-radius: 50%;
      filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.8));
      animation: fall-bomb linear;
      /* position: relative; ã¯ä¸è¦ã€ã¾ãŸã¯absoluteã« */
    }

    .bomb::before {
      content: 'ğŸ’£';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 25px;
      animation: bomb-pulse 0.5s infinite alternate;
    }

    @keyframes bomb-pulse {
      0% { transform: translate(-50%, -50%) scale(1); }
      100% { transform: translate(-50%, -50%) scale(1.2); }
    }

    .power-up {
      position: absolute; /* JavaScriptã§å‹•ã‹ã™ãŸã‚ */
      width: 45px;
      height: 45px;
      background: linear-gradient(45deg, #9370DB, #4169E1, #00CED1, #32CD32, #FFD700);
      border-radius: 50%;
      filter: drop-shadow(0 0 15px rgba(147, 112, 219, 0.8));
      animation: fall-powerup linear;
      /* position: relative; ã¯ä¸è¦ã€ã¾ãŸã¯absoluteã« */
      animation-name: fall-powerup, rainbow-rotate;
      animation-duration: inherit, 1s;
      animation-iteration-count: 1, infinite;
      animation-timing-function: linear, ease-in-out;
    }

    .power-up::before {
      content: 'â­';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 25px;
      animation: star-spin 2s linear infinite;
    }

    @keyframes star-spin {
      0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
      50% { transform: translate(-50%, -50%) rotate(180deg) scale(1.2); }
      100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); }
    }

    @keyframes rainbow-rotate {
      0% { filter: drop-shadow(0 0 15px rgba(147, 112, 219, 0.8)) hue-rotate(0deg); }
      100% { filter: drop-shadow(0 0 15px rgba(147, 112, 219, 0.8)) hue-rotate(360deg); }
    }

    @keyframes fall {
      0% { transform: translateY(-50px) rotate(0deg) scale(0.8); opacity: 0.6; }
      25% { opacity: 1; transform: translateY(25vh) rotate(90deg) scale(1); }
      50% { transform: translateY(50vh) rotate(180deg) scale(1.1); }
      75% { transform: translateY(75vh) rotate(270deg) scale(1); }
      100% { transform: translateY(100vh) rotate(360deg) scale(0.9); opacity: 0.8; }
    }

    @keyframes fall-special {
      0% { transform: translateY(-50px) rotate(0deg) scale(0.8); opacity: 0.8; }
      25% { opacity: 1; transform: translateY(25vh) rotate(90deg) scale(1.2); }
      50% { transform: translateY(50vh) rotate(180deg) scale(1.3); }
      75% { transform: translateY(75vh) rotate(270deg) scale(1.1); }
      100% { transform: translateY(100vh) rotate(360deg) scale(1); opacity: 0.9; }
    }

    @keyframes fall-golden {
      0% { transform: translateY(-50px) rotate(0deg) scale(0.9); opacity: 0.9; }
      25% { opacity: 1; transform: translateY(25vh) rotate(120deg) scale(1.3); }
      50% { transform: translateY(50vh) rotate(240deg) scale(1.4); }
      75% { transform: translateY(75vh) rotate(300deg) scale(1.2); }
      100% { transform: translateY(100vh) rotate(480deg) scale(1); opacity: 1; }
    }

    @keyframes fall-bomb {
      0% { transform: translateY(-50px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(180deg); opacity: 1; }
    }

    @keyframes fall-powerup {
      0% { transform: translateY(-50px) scale(0.8); opacity: 0.8; }
      25% { opacity: 1; transform: translateY(25vh) scale(1.1); }
      50% { transform: translateY(50vh) scale(1.2); }
      75% { transform: translateY(75vh) scale(1.1); }
      100% { transform: translateY(100vh) scale(1); opacity: 1; }
    }

    #scoreboard {
      position: fixed;
      top: 15px;
      right: 20px;
      font-size: 14px;
      font-weight: bold;
      color: #5a3d5c;
      background: linear-gradient(145deg,
        rgba(255, 255, 255, 0.95) 0%,
        rgba(255, 240, 250, 0.9) 100%
      );
      padding: 15px 20px;
      border-radius: 20px;
      z-index: 10;
      line-height: 1.6;
      box-shadow:
        0 8px 24px rgba(0, 0, 0, 0.15),
        0 4px 8px rgba(255, 105, 180, 0.2);
      border: 2px solid rgba(255, 182, 193, 0.4);
      backdrop-filter: blur(10px);
      min-width: 180px;
    }

    #level-display {
      position: fixed;
      top: 15px;
      left: 20px;
      font-size: 16px;
      font-weight: bold;
      color: #5a3d5c;
      background: linear-gradient(145deg,
        rgba(255, 255, 255, 0.95) 0%,
        rgba(240, 248, 255, 0.9) 100%
      );
      padding: 12px 18px;
      border-radius: 15px;
      z-index: 10;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.1),
        0 2px 4px rgba(65, 105, 225, 0.2);
      border: 2px solid rgba(100, 149, 237, 0.3);
      backdrop-filter: blur(5px);
    }

    .combo-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      font-weight: bold;
      color: #FFD700;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 15px;
      z-index: 15;
      display: none;
      animation: combo-pop 1s ease-out;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    @keyframes combo-pop {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    #gameover {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
      font-weight: bold;
      background: linear-gradient(145deg, rgba(0,0,0,0.9), rgba(50,50,50,0.8));
      color: white;
      padding: 30px 50px;
      border-radius: 20px;
      display: none;
      z-index: 20;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .control-btn {
      position: fixed;
      bottom: 15px;
      width: 55px;
      height: 55px;
      font-size: 22px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(145deg,
        rgba(255, 182, 193, 0.9) 0%,
        rgba(255, 105, 180, 0.8) 100%
      );
      color: white;
      z-index: 20;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
      box-shadow:
        0 6px 18px rgba(255, 105, 180, 0.4),
        0 3px 6px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.4);
      transition: all 0.2s ease;
    }

    .control-btn:active {
      transform: scale(0.95);
      box-shadow:
        0 3px 9px rgba(255, 105, 180, 0.4),
        0 1px 3px rgba(0, 0, 0, 0.2);
    }

    /* ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—åŠ¹æœè¡¨ç¤º */
    .power-effect {
      position: fixed;
      bottom: 150px;
      left: 20px;
      background: linear-gradient(45deg, #9370DB, #4169E1);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 15;
      display: none;
      animation: power-glow 0.5s ease-in-out infinite alternate;
    }

    @keyframes power-glow {
      0% { box-shadow: 0 0 10px rgba(147, 112, 219, 0.8); }
      100% { box-shadow: 0 0 20px rgba(147, 112, 219, 1); }
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³æ”¹å–„ */
    @media (max-height: 600px) {
      #character {
        bottom: 90px;
        max-height: 20vh;
      }
      .control-btn {
        bottom: 10px;
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      #scoreboard {
        font-size: 12px;
        padding: 10px 15px;
      }
    }

    @media (max-height: 500px) {
      #character {
        bottom: 100px;
        max-height: 18vh;
      }
    }

    /* ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .level-up-effect {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      font-weight: bold;
      color: #FFD700;
      background: linear-gradient(45deg, rgba(255, 215, 0, 0.9), rgba(255, 140, 0, 0.8));
      padding: 20px 40px;
      border-radius: 20px;
      z-index: 25;
      display: none;
      animation: level-up-animation 2s ease-out;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      border: 3px solid rgba(255, 255, 255, 0.8);
    }

    @keyframes level-up-animation {
      0% { transform: translate(-50%, -50%) scale(0.5) rotate(-10deg); opacity: 0; }
      30% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); opacity: 1; }
      70% { transform: translate(-50%, -50%) scale(1.1) rotate(-2deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0; }
    }
  </style>
</head>
<body>
  <img id="character" src="" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼">

  <div id="scoreboard">
    ã‚¹ã‚³ã‚¢: <span id="score">0</span><br>
    ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="highscore">0</span><br>
    æ®‹ã‚Š: <span id="timer">60</span>ç§’<br>
    ã‚³ãƒ³ãƒœ: <span id="combo">0</span>
  </div>

  <div id="level-display">
    ãƒ¬ãƒ™ãƒ«: <span id="level">1</span>
  </div>

  <div class="combo-display" id="combo-display"></div>
  <div class="power-effect" id="power-effect"></div>
  <div class="level-up-effect" id="level-up-effect"></div>

  <div id="gameover">
    <div>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</div>
    <div style="font-size: 18px; margin-top: 10px;">
      æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="final-score">0</span><br>
      åˆ°é”ãƒ¬ãƒ™ãƒ«: <span id="final-level">1</span>
    </div>
  </div>

  <script>
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šï¼ˆé•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼é˜²æ­¢ï¼‰
    document.addEventListener('contextmenu', e => { e.preventDefault(); return false; }, { passive: false });
    document.addEventListener('selectstart', e => { e.preventDefault(); return false; }, { passive: false });
    document.addEventListener('dragstart', e => { e.preventDefault(); return false; }, { passive: false });

    // è¦ç´ ã®å–å¾—
    const character = document.getElementById("character");
    const scoreDisplay = document.getElementById("score");
    const highscoreDisplay = document.getElementById("highscore");
    const timerDisplay = document.getElementById("timer");
    const levelDisplay = document.getElementById("level");
    const comboDisplay = document.getElementById("combo");
    const comboPopup = document.getElementById("combo-display");
    const powerEffect = document.getElementById("power-effect");
    const levelUpEffect = document.getElementById("level-up-effect");
    const gameover = document.getElementById("gameover");
    const finalScore = document.getElementById("final-score");
    const finalLevel = document.getElementById("final-level");

    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰è¿½åŠ : localStorageã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã‚€ â˜…â˜…â˜…
    const selectedImageFile = localStorage.getItem("selectedImage");
    const selectedCharName = localStorage.getItem("selectedName");

    if (selectedImageFile && selectedCharName) {
      character.src = selectedImageFile; // ç”»åƒã®ãƒ‘ã‚¹ã‚’è¨­å®š
      character.alt = selectedCharName;  // altãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
    } else {
      // localStorageã«æƒ…å ±ãŒãªã„å ´åˆ (ç›´æ¥stage.htmlã‚’é–‹ã„ãŸå ´åˆãªã©) ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
      character.src = "shaoran_web.PNG"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç”»åƒ
      character.alt = "ã‚·ãƒ£ã‚ªãƒ©ãƒ³";        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®altãƒ†ã‚­ã‚¹ãƒˆ
      console.warn("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠæƒ…å ±ãŒlocalStorageã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
    }
    // â˜…â˜…â˜… è¿½åŠ ã“ã“ã¾ã§ â˜…â˜…â˜…

    // ã‚²ãƒ¼ãƒ å¤‰æ•° (ã“ã“ã‹ã‚‰ä¸‹ã¯ã”æç¤ºã®ã‚³ãƒ¼ãƒ‰ã¨ã»ã¼åŒã˜ã§ã™)
    let score = 0;
    let highscore = 0;
    let timeLeft = 60;
    let level = 1;
    let combo = 0;
    let maxCombo = 0;
    let gameInterval;
    let bgParticleInterval;
    let isPowerUpActive = false;
    let powerUpEndTime = 0;
    let characterX = window.innerWidth / 2;

    // ã‚µã‚¦ãƒ³ãƒ‰è¨­å®šï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
    let se, bgm;
    try {
      se = new Audio("kirarin.mp3"); // åŠ¹æœéŸ³ãƒ•ã‚¡ã‚¤ãƒ«
      bgm = new Audio("bgm.mp3");     // BGMãƒ•ã‚¡ã‚¤ãƒ«
      bgm.loop = true;
      bgm.volume = 0.3; // å°‘ã—éŸ³é‡ã‚’ä¸‹ã’ã¾ã—ãŸ
    } catch (error) {
      console.error("ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®åˆæœŸåŒ–ã«å¤±æ•—: ", error);
      se = { play: () => {}, currentTime: 0 }; // ãƒ€ãƒŸãƒ¼
      bgm = { play: () => Promise.resolve(), loop: true, volume: 0.3 }; // ãƒ€ãƒŸãƒ¼
    }

    // ãƒã‚¤ã‚¹ã‚³ã‚¢åˆæœŸåŒ–
    try {
      highscore = parseInt(localStorage.getItem("sakuraGameHighscore")) || 0; // ã‚­ãƒ¼åã‚’å¤‰æ›´
    } catch (error) {
      console.log("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“");
    }
    highscoreDisplay.innerText = highscore;

    // èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ
    function createBackgroundParticle() {
      const particle = document.createElement("div");
      particle.className = "bg-particle";
      particle.style.left = Math.random() * window.innerWidth + "px";
      particle.style.width = particle.style.height = (Math.random() * 8 + 4) + "px";
      particle.style.animationDuration = (Math.random() * 10 + 8) + "s";
      document.body.appendChild(particle);

      setTimeout(() => {
        if (particle.parentNode) particle.remove();
      }, 20000);
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®æ›´æ–°
    function updateCharacterPosition() {
      character.style.left = `${characterX}px`;
    }

    // ãƒ¬ãƒ™ãƒ«è¨ˆç®—
    function calculateLevel() {
      return Math.floor(score / 100) + 1;
    }

    // é›£æ˜“åº¦ã«åŸºã¥ãã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆé–“éš”
    function getSpawnRate() {
      return Math.max(150, 700 - (level * 40)); // å°‘ã—èª¿æ•´
    }

    // ã‚¹ã‚³ã‚¢æ›´æ–°
    function updateScore(points = 1) {
      const previousLevel = level;

      if (isPowerUpActive) {
        points *= 2;
      }

      score += points;
      combo++;
      scoreDisplay.innerText = score;
      comboDisplay.innerText = combo;

      level = calculateLevel();
      levelDisplay.innerText = level;

      if (level > previousLevel) {
        showLevelUp();
        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ™‚ã‚¿ã‚¤ãƒãƒ¼å›å¾©ãƒœãƒ¼ãƒŠã‚¹ï¼ˆä¾‹ï¼‰
        // timeLeft = Math.min(timeLeft + 5, 90); // æœ€å¤§90ç§’ã¾ã§5ç§’å›å¾©
        // timerDisplay.innerText = timeLeft;
      }

      if (combo > 1) {
        showComboPopup();
      }

      if (combo > maxCombo) {
        maxCombo = combo;
      }

      if (se && typeof se.play === 'function') { // seãŒnullã§ãªã„ã‹ç¢ºèª
        se.currentTime = 0;
        se.play().catch(err => console.warn("åŠ¹æœéŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
      }

      if (points >= 5) {
        showSpecialEffect();
      }
    }

    // ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
    function resetCombo() {
      combo = 0;
      comboDisplay.innerText = combo;
    }

    // ã‚³ãƒ³ãƒœãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
    function showComboPopup() {
      comboPopup.textContent = `${combo} COMBO!`;
      comboPopup.style.display = 'block';
      setTimeout(() => {
        comboPopup.style.display = 'none';
      }, 1000);
    }

    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—è¡¨ç¤º
    function showLevelUp() {
      levelUpEffect.textContent = `LEVEL ${level}!`;
      levelUpEffect.style.display = 'block';
      setTimeout(() => {
        levelUpEffect.style.display = 'none';
      }, 2000);
    }

    // ç‰¹åˆ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function showSpecialEffect() {
      scoreDisplay.style.transform = 'scale(1.3)';
      scoreDisplay.style.color = '#FFD700';
      setTimeout(() => {
        scoreDisplay.style.transform = 'scale(1)';
        scoreDisplay.style.color = '#5a3d5c';
      }, 500);
    }

    let powerUpTimerId = null; // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã®ã‚¿ã‚¤ãƒãƒ¼IDã‚’ä¿æŒ
    // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—åŠ¹æœ
    function activatePowerUp() {
      if (isPowerUpActive) { // æ—¢ã«ç™ºå‹•ä¸­ã®å ´åˆã€æ™‚é–“ã‚’å»¶é•·
        powerUpEndTime += 10000; // 10ç§’å»¶é•·
        // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã—ã„ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
        if (powerUpTimerId) clearInterval(powerUpTimerId);
      } else {
        isPowerUpActive = true;
        powerUpEndTime = Date.now() + 10000; // 10ç§’é–“
        character.classList.add('powerup');
        powerEffect.textContent = 'âœ¨ãƒ€ãƒ–ãƒ«ã‚¹ã‚³ã‚¢ä¸­ï¼';
        powerEffect.style.display = 'block';
      }

      powerUpTimerId = setInterval(() => {
        const remaining = Math.ceil((powerUpEndTime - Date.now()) / 1000);
        if (remaining <= 0) {
          clearInterval(powerUpTimerId);
          powerUpTimerId = null;
          deactivatePowerUp();
        } else {
          powerEffect.textContent = `âœ¨ãƒ€ãƒ–ãƒ«ã‚¹ã‚³ã‚¢ä¸­ï¼(${remaining}s)`;
        }
      }, 100);
    }

    // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—è§£é™¤
    function deactivatePowerUp() {
      isPowerUpActive = false;
      character.classList.remove('powerup');
      powerEffect.style.display = 'none';
      if (powerUpTimerId) { //å¿µã®ãŸã‚ã‚¿ã‚¤ãƒãƒ¼ãŒæ®‹ã£ã¦ã„ã‚Œã°ã‚¯ãƒªã‚¢
          clearInterval(powerUpTimerId);
          powerUpTimerId = null;
      }
    }

    // ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
    function createItem() {
      if (timeLeft <= 0) return; // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã¯ç”Ÿæˆã—ãªã„

      const item = document.createElement("div");
      const rand = Math.random();
      let itemType = "normal"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é€šå¸¸ã®èŠ±ã³ã‚‰

      // ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ—ã®æ±ºå®šï¼ˆãƒ¬ãƒ™ãƒ«ã«ã‚ˆã£ã¦å‡ºç¾ç‡å¤‰åŒ–ï¼‰
      if (rand < 0.05 && level >= 3) { // çˆ†å¼¾ (ãƒ¬ãƒ™ãƒ«3ä»¥ä¸Šã§5%)
        itemType = "bomb";
      } else if (rand < 0.1 && level >= 2) { // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ— (ãƒ¬ãƒ™ãƒ«2ä»¥ä¸Šã§æ¬¡ã®5%)
        itemType = "powerup";
      } else if (rand < 0.25) { // ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³èŠ±ã³ã‚‰ (æ¬¡ã®15%)
        itemType = "golden";
      } else if (rand < 0.45) { // ç‰¹åˆ¥ãªèŠ±ã³ã‚‰ (æ¬¡ã®20%)
        itemType = "special";
      }
      // ãã‚Œä»¥å¤–ã¯é€šå¸¸ã®èŠ±ã³ã‚‰ (55%)

      switch(itemType) {
        case "bomb":
          item.className = "bomb";
          item.dataset.type = "bomb";
          item.dataset.points = "-10";
          break;
        case "powerup":
          item.className = "power-up";
          item.dataset.type = "powerup";
          item.dataset.points = "0"; // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—è‡ªä½“ã«ã‚¹ã‚³ã‚¢ã¯ãªã—
          break;
        case "golden":
          item.className = "petal golden";
          item.dataset.type = "golden";
          item.dataset.points = "5";
          break;
        case "special":
          item.className = "petal special";
          item.dataset.type = "special";
          item.dataset.points = "2";
          break;
        default: // normal
          item.className = "petal";
          item.dataset.type = "normal";
          item.dataset.points = "1";
      }

      item.style.left = Math.random() * (window.innerWidth - (parseInt(item.style.width) || 40)) + "px"; // ã‚¢ã‚¤ãƒ†ãƒ å¹…ã‚’è€ƒæ…®
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã¯ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å°‘ã—é€Ÿãã™ã‚‹ï¼ˆæœ€ä½1.5ç§’ã€ãƒ¬ãƒ™ãƒ«ã”ã¨ã«0.1ç§’çŸ­ç¸®ã€æœ€å¤§ã§å…ƒã®é€Ÿåº¦ã®åŠåˆ†ç¨‹åº¦ã¾ã§ï¼‰
      let animationDuration = Math.max(1.5, (2 + Math.random() * 2) - (level * 0.1));
      item.style.animationDuration = animationDuration + "s";
      document.body.appendChild(item);

      const checkCollision = setInterval(() => {
        if (!item.parentNode || timeLeft <= 0) { // ã‚¢ã‚¤ãƒ†ãƒ ãŒå­˜åœ¨ã—ãªã„ã‹ã‚²ãƒ¼ãƒ çµ‚äº†ãªã‚‰åˆ¤å®šåœæ­¢
            clearInterval(checkCollision);
            if(item.parentNode) item.remove(); // ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«æ®‹ã£ã¦ã„ã‚Œã°å‰Šé™¤
            return;
        }
        const rect1 = item.getBoundingClientRect();
        const rect2 = character.getBoundingClientRect();

        if (
          rect1.top < rect2.bottom &&
          rect1.bottom > rect2.top &&
          rect1.left < rect2.right &&
          rect1.right > rect2.left
        ) {
          const type = item.dataset.type;
          const points = parseInt(item.dataset.points);

          if (type === "bomb") {
            score = Math.max(0, score + points);
            scoreDisplay.innerText = score;
            resetCombo();
            document.body.style.background = '#ff6b6b'; // ãƒ’ãƒƒãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            setTimeout(() => {
              document.body.style.background = 'linear-gradient(135deg, #ffeef5 0%, #ffe8f0 25%, #f8e8ff 50%, #e8f0ff 75%, #f0f8ff 100%)';
            }, 150);
          } else if (type === "powerup") {
            activatePowerUp();
          } else {
            updateScore(points);
          }

          item.remove();
          clearInterval(checkCollision);
        }
      }, 30); // åˆ¤å®šé »åº¦ã‚’å°‘ã—ä¸Šã’ã‚‹

      // ã‚¢ã‚¤ãƒ†ãƒ ãŒç”»é¢å¤–ã«å‡ºã‚‹ã‹ä¸€å®šæ™‚é–“ã§å‰Šé™¤
      setTimeout(() => {
        if (item.parentNode) {
          item.remove();
          // çˆ†å¼¾ã¨ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ä»¥å¤–ã‚’é€ƒã—ãŸã‚‰ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
          if (item.dataset.type !== "bomb" && item.dataset.type !== "powerup") {
            resetCombo();
          }
        }
        clearInterval(checkCollision);
      }, animationDuration * 1000 + 200); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚ˆã‚Šå°‘ã—é•·ã‚ã«è¨­å®š
    }

    let gameTimerId = null; // ã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒãƒ¼ID
    let itemSpawnerId = null; // ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ID

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame() {
      if (bgm && typeof bgm.play === 'function' && bgm.paused) {
        bgm.play().catch(err => console.warn("BGMå†ç”Ÿã«å¤±æ•—:", err));
      }

      itemSpawnerId = setInterval(createItem, getSpawnRate());
      bgParticleInterval = setInterval(createBackgroundParticle, 500);

      gameTimerId = setInterval(() => {
        if (timeLeft <= 0) { // timeLeftãŒ0ä»¥ä¸‹ã«ãªã£ãŸã‚‰ã“ã“ã§å…¨ã¦ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ã‚¯ãƒªã‚¢
            clearInterval(gameTimerId);
            clearInterval(itemSpawnerId);
            clearInterval(bgParticleInterval);
            if (powerUpTimerId) clearInterval(powerUpTimerId); // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ã‚‚ã‚¯ãƒªã‚¢
            endGame();
            return; // ã“ã‚Œä»¥ä¸Šå‡¦ç†ã‚’é€²ã‚ãªã„
        }

        timeLeft--;
        timerDisplay.innerText = timeLeft;

        // ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆé–“éš”ã‚’å‹•çš„ã«èª¿æ•´
        clearInterval(itemSpawnerId);
        itemSpawnerId = setInterval(createItem, getSpawnRate());

      }, 1000);
    }

    // ã‚²ãƒ¼ãƒ çµ‚äº†
    function endGame() {
      if (bgm && typeof bgm.pause === 'function') bgm.pause(); // BGMåœæ­¢

      finalScore.innerText = score;
      finalLevel.innerText = level;
      gameover.style.display = "block";

      if (score > highscore) {
        highscore = score; // highscoreå¤‰æ•°ã‚’æ›´æ–°
        try {
          localStorage.setItem("sakuraGameHighscore", highscore); // æ–°ã—ã„ã‚­ãƒ¼åã§ä¿å­˜
          highscoreDisplay.innerText = highscore;
        } catch (error) {
          console.log("ãƒã‚¤ã‚¹ã‚³ã‚¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      }
      // å‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å…¨ã¦å‰Šé™¤
      document.querySelectorAll('.petal, .bomb, .power-up, .bg-particle').forEach(el => el.remove());
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ“ä½œ (ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰)
    document.addEventListener("keydown", (e) => {
      if (timeLeft <= 0) return; // ã‚²ãƒ¼ãƒ çµ‚äº†å¾Œã¯æ“ä½œç„¡åŠ¹
      let moved = false;
      if (e.key === "ArrowLeft") {
        characterX -= 30;
        moved = true;
      } else if (e.key === "ArrowRight") {
        characterX += 30;
        moved = true;
      } else if (e.key === " " || e.key === "ArrowUp") {
        e.preventDefault();
        jump();
      }
      if (moved) {
        const charRect = character.getBoundingClientRect();
        characterX = Math.max(charRect.width / 2, Math.min(window.innerWidth - (charRect.width / 2), characterX));
        updateCharacterPosition();
      }
    });

    // ã‚¸ãƒ£ãƒ³ãƒ—æ©Ÿèƒ½
    function jump() {
      if (!character.classList.contains("jump") && timeLeft > 0) {
        character.classList.add("jump");
        setTimeout(() => character.classList.remove("jump"), 600); // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ™‚é–“
      }
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§ã‚¸ãƒ£ãƒ³ãƒ—
    character.addEventListener("click", (e) => {
      if (timeLeft <= 0) return;
      e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç”»åƒãƒ‰ãƒ©ãƒƒã‚°ãªã©ã‚’é˜²ã
      jump();
    }, { passive: false });

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ç”Ÿæˆã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const leftBtn = document.createElement("button");
    leftBtn.innerText = "â—€";
    leftBtn.className = "control-btn";
    leftBtn.style.left = "20px";

    const rightBtn = document.createElement("button");
    rightBtn.innerText = "â–¶";
    rightBtn.className = "control-btn";
    rightBtn.style.right = "20px";

    const jumpBtn = document.createElement("button");
    jumpBtn.innerText = "â¬†";
    jumpBtn.className = "control-btn";
    jumpBtn.style.right = "90px";
    jumpBtn.style.background = "linear-gradient(145deg, rgba(147, 112, 219, 0.9), rgba(65, 105, 225, 0.8))";

    document.body.appendChild(leftBtn);
    document.body.appendChild(rightBtn);
    document.body.appendChild(jumpBtn);

    let moveInterval = null;
    function startMove(direction) {
      if (moveInterval || timeLeft <= 0) return;
      moveInterval = setInterval(() => {
        if (direction === "left") {
          characterX -= 15;
        } else if (direction === "right") {
          characterX += 15;
        }
        const charRect = character.getBoundingClientRect();
        characterX = Math.max(charRect.width / 2, Math.min(window.innerWidth - (charRect.width / 2), characterX));
        updateCharacterPosition();
      }, 50);
    }

    function stopMove() {
      clearInterval(moveInterval);
      moveInterval = null;
    }

    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ (ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³)
    leftBtn.addEventListener("touchstart", (e) => { e.preventDefault(); startMove("left"); }, { passive: false });
    rightBtn.addEventListener("touchstart", (e) => { e.preventDefault(); startMove("right"); }, { passive: false });
    jumpBtn.addEventListener("touchstart", (e) => { e.preventDefault(); jump(); }, { passive: false });

    // touchend/mouseupã¯documentã«å¯¾ã—ã¦è¨­å®šã™ã‚‹ã¨ã€ãƒœã‚¿ãƒ³å¤–ã§æŒ‡ã‚’é›¢ã—ã¦ã‚‚æ­¢ã¾ã‚‹
    document.addEventListener("touchend", (e) => {
        if (moveInterval) { // moveIntervalãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã®ã¿stopMoveã‚’å‘¼ã¶
            // e.preventDefault(); // çŠ¶æ³ã«ã‚ˆã£ã¦å¿…è¦ãªã‚‰
            stopMove();
        }
    }, { passive: false });


    // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ (ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³)
    leftBtn.addEventListener("mousedown", () => startMove("left"));
    rightBtn.addEventListener("mousedown", () => startMove("right"));
    jumpBtn.addEventListener("mousedown", jump);
    document.addEventListener("mouseup", stopMove); // ãƒœã‚¿ãƒ³å¤–ã§é›¢ã—ã¦ã‚‚æ­¢ã¾ã‚‹ã‚ˆã†ã«

    // ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œ
    let touchStartX = null;
    let touchStartY = null;
    const swipeThreshold = 30; // ã‚¹ãƒ¯ã‚¤ãƒ—ã¨åˆ¤å®šã™ã‚‹æœ€å°è·é›¢

    document.addEventListener("touchstart", (e) => {
      if (timeLeft <= 0 || e.target.classList.contains('control-btn')) return;
      // ç”»é¢ä¸Šéƒ¨ï¼ˆã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ã‚„ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºä»˜è¿‘ï¼‰ã®ã‚¿ãƒƒãƒã¯ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œã‹ã‚‰é™¤å¤–ã™ã‚‹ï¼ˆä»»æ„ï¼‰
      // if (e.changedTouches[0].clientY < 150) return;
      touchStartX = e.changedTouches[0].clientX;
      touchStartY = e.changedTouches[0].clientY;
    }, { passive: true });

    document.addEventListener("touchmove", (e) => {
        if (timeLeft <= 0 || !touchStartX || e.target.classList.contains('control-btn')) return;

        let currentX = e.changedTouches[0].clientX;
        let deltaX = currentX - touchStartX;

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å¹…ã‚’è€ƒæ…®ã—ã¦ç”»é¢ç«¯ã§ã®ç§»å‹•ã‚’åˆ¶é™
        const charRect = character.getBoundingClientRect();
        const minCharX = charRect.width / 2;
        const maxCharX = window.innerWidth - (charRect.width / 2);

        characterX += deltaX * 0.6; // ã‚¹ãƒ¯ã‚¤ãƒ—æ„Ÿåº¦èª¿æ•´
        characterX = Math.max(minCharX, Math.min(maxCharX, characterX));
        updateCharacterPosition();

        touchStartX = currentX; // æ¬¡ã®moveã‚¤ãƒ™ãƒ³ãƒˆã®ãŸã‚ã«é–‹å§‹ç‚¹ã‚’æ›´æ–°
    }, { passive: true }); // ã‚¹ãƒ ãƒ¼ã‚ºãªæ“ä½œã®ãŸã‚

    document.addEventListener("touchend", (e) => {
      if (timeLeft <= 0 || touchStartX === null || touchStartY === null || e.target.classList.contains('control-btn')) {
        touchStartX = null; touchStartY = null; return;
      }

      const deltaX = e.changedTouches[0].clientX - touchStartX;
      const deltaY = e.changedTouches[0].clientY - touchStartY;

      // ä¸Šæ–¹å‘ã¸ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã‚¸ãƒ£ãƒ³ãƒ—
      if (Math.abs(deltaY) > Math.abs(deltaX) && deltaY < -swipeThreshold) {
        jump();
      }
      touchStartX = null;
      touchStartY = null;
    }, { passive: true });


    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', () => {
      const charRect = character.getBoundingClientRect();
      characterX = Math.max(charRect.width / 2, Math.min(window.innerWidth - (charRect.width / 2), characterX));
      updateCharacterPosition();
    });

    // åˆæœŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®è¨­å®š & BGMå†ç”Ÿè©¦è¡Œ
    updateCharacterPosition();

    // BGMå†ç”Ÿã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾ŒãŒæ¨å¥¨ã•ã‚Œã‚‹ãŸã‚ã€æœ€åˆã®ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§è©¦ã¿ã‚‹
    function attemptBgmPlay() {
        if (bgm && typeof bgm.play === 'function' && bgm.paused) {
            bgm.play().then(() => {
                // å†ç”Ÿã«æˆåŠŸã—ãŸã‚‰ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
                document.body.removeEventListener('click', attemptBgmPlay);
                document.body.removeEventListener('touchstart', attemptBgmPlay);
            }).catch(error => {
                console.warn("BGMã®å†ç”Ÿè©¦è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                // å¤±æ•—ã—ãŸå ´åˆã§ã‚‚ã€å†åº¦è©¦è¡Œã§ãã‚‹ã‚ˆã†ã«ãƒªã‚¹ãƒŠãƒ¼ã¯æ®‹ã™ã‹ã€åˆ¥ã®UIã‚’ç”¨æ„ã™ã‚‹
            });
        } else if (bgm && !bgm.paused) { // ã™ã§ã«å†ç”Ÿä¸­ãªã‚‰ãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤
            document.body.removeEventListener('click', attemptBgmPlay);
            document.body.removeEventListener('touchstart', attemptBgmPlay);
        }
    }
    document.body.addEventListener('click', attemptBgmPlay, {once: true}); // æœ€åˆã®ã‚¯ãƒªãƒƒã‚¯ã§è©¦ã™
    document.body.addEventListener('touchstart', attemptBgmPlay, {once: true}); // æœ€åˆã®ã‚¿ãƒƒãƒã§è©¦ã™

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    startGame();

  </script>
</body>
</html>
