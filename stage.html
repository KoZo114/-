<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¡œèˆã†ç©ºã‚­ãƒ£ãƒƒãƒã‚²ãƒ¼ãƒ  - ç©¶æ¥µç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');

    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
      background: linear-gradient(135deg,
        #ffeef5 0%, #ffe8f0 25%, #f8e8ff 50%, #e8f0ff 75%, #f0f8ff 100%
      );
      font-family: 'Noto Sans JP', sans-serif;
      touch-action: manipulation;
      -webkit-overflow-scrolling: touch;
    }

    .bg-particle {
      position: absolute;
      background: rgba(255, 182, 193, 0.3);
      border-radius: 50%;
      pointer-events: none;
      animation: float-bg linear infinite;
      z-index: 0;
    }

    @keyframes float-bg {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
    }

    #character {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      max-height: 25vh;
      max-width: 120px;
      height: auto;
      z-index: 5;
      filter: drop-shadow(2px 4px 8px rgba(0,0,0,0.2));
      transition: all 0.3s ease;
    }

    #character.jump {
      animation: jump 0.6s ease;
    }

    #character.powerup {
      filter: drop-shadow(0 0 15px #FFD700) drop-shadow(2px 4px 8px rgba(0,0,0,0.2));
      transform: translateX(-50%) scale(1.1);
    }

    @keyframes jump {
      0%   { transform: translateX(-50%) translateY(0); }
      30%  { transform: translateX(-50%) translateY(-60px); }
      60%  { transform: translateX(-50%) translateY(-60px); }
      100% { transform: translateX(-50%) translateY(0); }
    }

    .petal {
      position: absolute;
      width: 35px;
      height: 35px;
      background: radial-gradient(ellipse at center,
        #ffb3d9 0%, #ffc9e0 40%, #ffe0f0 80%, rgba(255, 192, 224, 0.8) 100%
      );
      border-radius: 50% 10% 50% 10%;
      box-shadow:
        0 2px 4px rgba(255, 105, 180, 0.3),
        inset 0 1px 2px rgba(255, 255, 255, 0.5);
      pointer-events: none;
      animation: fall linear;
      z-index: 1;
      filter: drop-shadow(0 0 3px rgba(255, 182, 193, 0.6));
    }

    .petal.special {
      width: 40px;
      height: 40px;
      background: radial-gradient(circle, #FFD700 0%, #FFA500 50%, #FF69B4 100%);
      filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
      animation: fall-special linear;
    }

    .petal.golden {
      width: 45px;
      height: 45px;
      background: radial-gradient(circle, #FFD700 0%, #FFFF00 30%, #FFA500 70%, #FF4500 100%);
      filter: drop-shadow(0 0 15px rgba(255, 215, 0, 1)) drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
      animation: fall-golden linear;
      border: 2px solid rgba(255, 255, 255, 0.8);
    }

    .bomb {
      position: absolute;
      width: 40px;
      height: 40px;
      background: radial-gradient(circle, #FF0000 0%, #8B0000 70%, #000000 100%);
      border-radius: 50%;
      filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.8));
      animation: fall-bomb linear;
    }

    .bomb::before {
      content: 'ğŸ’£';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 25px;
      animation: bomb-pulse 0.5s infinite alternate;
    }

    @keyframes bomb-pulse {
      0% { transform: translate(-50%, -50%) scale(1); }
      100% { transform: translate(-50%, -50%) scale(1.2); }
    }

    .power-up {
      position: absolute;
      width: 45px;
      height: 45px;
      background: linear-gradient(45deg, #9370DB, #4169E1, #00CED1, #32CD32, #FFD700);
      border-radius: 50%;
      filter: drop-shadow(0 0 15px rgba(147, 112, 219, 0.8));
      animation: fall-powerup linear;
      animation-name: fall-powerup, rainbow-rotate;
      animation-duration: inherit, 1s;
      animation-iteration-count: 1, infinite;
      animation-timing-function: linear, ease-in-out;
    }

    .power-up::before {
      content: 'â­';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 25px;
      animation: star-spin 2s linear infinite;
    }

    /* â˜…â˜…â˜… è¿½åŠ : æ™‚é–“å¢—åŠ ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« â˜…â˜…â˜… */
    .time-plus {
      position: absolute;
      width: 40px;
      height: 40px;
      background: radial-gradient(circle, #fafad2 0%, #eee8aa 50%, #daa520 100%); /* ã‚´ãƒ¼ãƒ«ãƒ‰ã£ã½ã„ç ‚æ™‚è¨ˆè‰² */
      border-radius: 50%;
      filter: drop-shadow(0 0 8px rgba(218, 165, 32, 0.7)); /* ã‚´ãƒ¼ãƒ«ãƒ‰ã®å½± */
      animation: fall-time-plus linear; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åã‚’å¤‰æ›´ */
    }

    .time-plus::before {
      content: 'âŒ›ï¸';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 25px;
      animation: time-pulse 1.5s ease-in-out infinite alternate; /* ç‹¬è‡ªã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    }
    @keyframes time-pulse {
        0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0.7; }
        50% { transform: translate(-50%, -50%) scale(1.1) rotate(10deg); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0.7; }
    }
    /* â˜…â˜…â˜… ã“ã“ã¾ã§æ™‚é–“å¢—åŠ ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ã‚¿ã‚¤ãƒ« â˜…â˜…â˜… */


    @keyframes star-spin {
      0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
      50% { transform: translate(-50%, -50%) rotate(180deg) scale(1.2); }
      100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); }
    }

    @keyframes rainbow-rotate {
      0% { filter: drop-shadow(0 0 15px rgba(147, 112, 219, 0.8)) hue-rotate(0deg); }
      100% { filter: drop-shadow(0 0 15px rgba(147, 112, 219, 0.8)) hue-rotate(360deg); }
    }

    @keyframes fall {
      0% { transform: translateY(-50px) rotate(0deg) scale(0.8); opacity: 0.6; }
      25% { opacity: 1; transform: translateY(25vh) rotate(90deg) scale(1); }
      50% { transform: translateY(50vh) rotate(180deg) scale(1.1); }
      75% { transform: translateY(75vh) rotate(270deg) scale(1); }
      100% { transform: translateY(100vh) rotate(360deg) scale(0.9); opacity: 0.8; }
    }

    @keyframes fall-special {
      0% { transform: translateY(-50px) rotate(0deg) scale(0.8); opacity: 0.8; }
      25% { opacity: 1; transform: translateY(25vh) rotate(90deg) scale(1.2); }
      50% { transform: translateY(50vh) rotate(180deg) scale(1.3); }
      75% { transform: translateY(75vh) rotate(270deg) scale(1.1); }
      100% { transform: translateY(100vh) rotate(360deg) scale(1); opacity: 0.9; }
    }

    @keyframes fall-golden {
      0% { transform: translateY(-50px) rotate(0deg) scale(0.9); opacity: 0.9; }
      25% { opacity: 1; transform: translateY(25vh) rotate(120deg) scale(1.3); }
      50% { transform: translateY(50vh) rotate(240deg) scale(1.4); }
      75% { transform: translateY(75vh) rotate(300deg) scale(1.2); }
      100% { transform: translateY(100vh) rotate(480deg) scale(1); opacity: 1; }
    }

    @keyframes fall-bomb { /* çˆ†å¼¾ã¯å°‘ã—é€Ÿãã€ä¸è¦å‰‡ã«è½ã¡ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ */
      0% { transform: translateY(-50px) rotate(0deg) scale(1); opacity: 1; }
      30% { transform: translateY(30vh) rotate(-20deg) scale(1.05); }
      60% { transform: translateY(60vh) rotate(15deg) scale(1.1); }
      100% { transform: translateY(100vh) rotate(10deg) scale(1); opacity: 1; }
    }

    @keyframes fall-powerup {
      0% { transform: translateY(-50px) scale(0.8); opacity: 0.8; }
      25% { opacity: 1; transform: translateY(25vh) scale(1.1); }
      50% { transform: translateY(50vh) scale(1.2); }
      75% { transform: translateY(75vh) scale(1.1); }
      100% { transform: translateY(100vh) scale(1); opacity: 1; }
    }
    /* â˜…â˜…â˜… è¿½åŠ : æ™‚é–“å¢—åŠ ã‚¢ã‚¤ãƒ†ãƒ ã®è½ä¸‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ â˜…â˜…â˜… */
    @keyframes fall-time-plus { /* ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã¨ä¼¼ãŸã‚ˆã†ãªã‚†ã£ãã‚Šã¨ã—ãŸæºã‚Œ */
      0% { transform: translateY(-50px) translateX(0px) rotate(0deg) scale(0.9); opacity: 0.7;}
      25% { opacity: 1; transform: translateY(25vh) translateX(10px) rotate(5deg) scale(1);}
      50% { transform: translateY(50vh) translateX(-10px) rotate(-5deg) scale(1.1);}
      75% { transform: translateY(75vh) translateX(5px) rotate(2deg) scale(1);}
      100% { transform: translateY(100vh) translateX(0px) rotate(0deg) scale(0.9); opacity: 1;}
    }

    #scoreboard {
      position: fixed;
      top: 15px;
      right: 20px;
      font-size: 14px;
      font-weight: bold;
      color: #5a3d5c;
      background: linear-gradient(145deg,
        rgba(255, 255, 255, 0.95) 0%,
        rgba(255, 240, 250, 0.9) 100%
      );
      padding: 15px 20px;
      border-radius: 20px;
      z-index: 10;
      line-height: 1.6;
      box-shadow:
        0 8px 24px rgba(0, 0, 0, 0.15),
        0 4px 8px rgba(255, 105, 180, 0.2);
      border: 2px solid rgba(255, 182, 193, 0.4);
      backdrop-filter: blur(10px);
      min-width: 180px;
    }

    #level-display {
      position: fixed;
      top: 15px;
      left: 20px;
      font-size: 16px;
      font-weight: bold;
      color: #5a3d5c;
      background: linear-gradient(145deg,
        rgba(255, 255, 255, 0.95) 0%,
        rgba(240, 248, 255, 0.9) 100%
      );
      padding: 12px 18px;
      border-radius: 15px;
      z-index: 10;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.1),
        0 2px 4px rgba(65, 105, 225, 0.2);
      border: 2px solid rgba(100, 149, 237, 0.3);
      backdrop-filter: blur(5px);
    }

    .combo-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      font-weight: bold;
      color: #FFD700;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 20px;
      border-radius: 15px;
      z-index: 15;
      display: none;
      animation: combo-pop 1s ease-out;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    @keyframes combo-pop {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    #gameover {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
      font-weight: bold;
      background: linear-gradient(145deg, rgba(0,0,0,0.9), rgba(50,50,50,0.8));
      color: white;
      padding: 30px 50px;
      border-radius: 20px;
      display: none;
      z-index: 20;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    #return-to-select-btn {
        background-color: #f08080;
        color: white;
        border: none;
        padding: 12px 25px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin-top: 25px;
        cursor: pointer;
        border-radius: 8px;
        transition: background-color 0.3s ease;
    }
    #return-to-select-btn:hover {
        background-color: #cd5c5c;
    }


    .control-btn {
      position: fixed;
      bottom: 15px;
      width: 55px;
      height: 55px;
      font-size: 22px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(145deg,
        rgba(255, 182, 193, 0.9) 0%,
        rgba(255, 105, 180, 0.8) 100%
      );
      color: white;
      z-index: 20;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
      box-shadow:
        0 6px 18px rgba(255, 105, 180, 0.4),
        0 3px 6px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.4);
      transition: all 0.2s ease;
    }

    .control-btn:active {
      transform: scale(0.95);
      box-shadow:
        0 3px 9px rgba(255, 105, 180, 0.4),
        0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .power-effect {
      position: fixed;
      bottom: 150px;
      left: 20px;
      background: linear-gradient(45deg, #9370DB, #4169E1);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 15;
      display: none;
      animation: power-glow 0.5s ease-in-out infinite alternate;
    }

    @keyframes power-glow {
      0% { box-shadow: 0 0 10px rgba(147, 112, 219, 0.8); }
      100% { box-shadow: 0 0 20px rgba(147, 112, 219, 1); }
    }

    @media (max-height: 600px) {
      #character {
        bottom: 90px;
        max-height: 20vh;
      }
      .control-btn {
        bottom: 10px;
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      #scoreboard {
        font-size: 12px;
        padding: 10px 15px;
      }
    }

    @media (max-height: 500px) {
      #character {
        bottom: 100px;
        max-height: 18vh;
      }
    }

    .level-up-effect {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      font-weight: bold;
      color: #FFD700;
      background: linear-gradient(45deg, rgba(255, 215, 0, 0.9), rgba(255, 140, 0, 0.8));
      padding: 20px 40px;
      border-radius: 20px;
      z-index: 25;
      display: none;
      animation: level-up-animation 2s ease-out;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      border: 3px solid rgba(255, 255, 255, 0.8);
    }

    @keyframes level-up-animation {
      0% { transform: translate(-50%, -50%) scale(0.5) rotate(-10deg); opacity: 0; }
      30% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); opacity: 1; }
      70% { transform: translate(-50%, -50%) scale(1.1) rotate(-2deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0; }
    }
  </style>
</head>
<body>
  <img id="character" src="" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼">

  <div id="scoreboard">
    ã‚¹ã‚³ã‚¢: <span id="score">0</span><br>
    ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="highscore">0</span><br>
    æ®‹ã‚Š: <span id="timer">60</span>ç§’<br>
    ã‚³ãƒ³ãƒœ: <span id="combo">0</span>
  </div>

  <div id="level-display">
    ãƒ¬ãƒ™ãƒ«: <span id="level">1</span>
  </div>

  <div class="combo-display" id="combo-display"></div>
  <div class="power-effect" id="power-effect"></div>
  <div class="level-up-effect" id="level-up-effect"></div>

  <div id="gameover">
    <div>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</div>
    <div style="font-size: 18px; margin-top: 10px;">
      æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="final-score">0</span><br>
      åˆ°é”ãƒ¬ãƒ™ãƒ«: <span id="final-level">1</span>
    </div>
    <button id="return-to-select-btn">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã«æˆ»ã‚‹</button>
  </div>

  <script>
    document.addEventListener('contextmenu', e => { e.preventDefault(); return false; }, { passive: false });
    document.addEventListener('selectstart', e => { e.preventDefault(); return false; }, { passive: false });
    document.addEventListener('dragstart', e => { e.preventDefault(); return false; }, { passive: false });

    const character = document.getElementById("character");
    const scoreDisplay = document.getElementById("score");
    const highscoreDisplay = document.getElementById("highscore");
    const timerDisplay = document.getElementById("timer");
    const levelDisplay = document.getElementById("level");
    const comboDisplay = document.getElementById("combo");
    const comboPopup = document.getElementById("combo-display");
    const powerEffect = document.getElementById("power-effect");
    const levelUpEffect = document.getElementById("level-up-effect");
    const gameover = document.getElementById("gameover");
    const finalScore = document.getElementById("final-score");
    const finalLevel = document.getElementById("final-level");
    const returnToSelectBtn = document.getElementById("return-to-select-btn");

    const selectedImageFile = localStorage.getItem("selectedImage");
    const selectedCharName = localStorage.getItem("selectedName");

    if (selectedImageFile && selectedCharName) {
      character.src = selectedImageFile;
      character.alt = selectedCharName;
    } else {
      character.src = "shaoran_web.PNG";
      character.alt = "ã‚·ãƒ£ã‚ªãƒ©ãƒ³";
      console.warn("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠæƒ…å ±ãŒlocalStorageã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
    }

    let score = 0;
    let highscore = 0;
    let timeLeft = 60; // åˆæœŸæ™‚é–“60ç§’
    const MAX_TIME_LEFT = 90; // æ™‚é–“å¢—åŠ ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚ˆã‚‹æœ€å¤§æ™‚é–“
    const MAX_LEVEL = 5;    // â˜…â˜…â˜… æœ€å¤§ãƒ¬ãƒ™ãƒ«è¨­å®š â˜…â˜…â˜…
    let level = 1;
    // â˜…â˜…â˜… è¿½åŠ : ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã«å¿…è¦ãªã‚¹ã‚³ã‚¢ã®é–¾å€¤ â˜…â˜…â˜…
    // levelThresholds[i] ã¯ã€ãƒ¬ãƒ™ãƒ« (i+1) ã«ãªã‚‹ãŸã‚ã«å¿…è¦ãªæœ€ä½ã‚¹ã‚³ã‚¢
    const levelThresholds = [0, 30, 80, 150, 250]; // Lv1, Lv2, Lv3, Lv4, Lv5 ã®é–¾å€¤
    let combo = 0;
    let maxCombo = 0;
    let gameInterval; // createItemã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ID (startGameå†…ã§ä»£å…¥)
    let bgParticleInterval;
    let isPowerUpActive = false;
    let powerUpEndTime = 0;
    let characterX = window.innerWidth / 2;

    let se, bgm;
    try {
      se = new Audio("kirarin.mp3");
      bgm = new Audio("bgm.mp3");
      bgm.loop = true;
      bgm.volume = 0.3;
    } catch (error) {
      console.error("ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®åˆæœŸåŒ–ã«å¤±æ•—: ", error);
      se = { play: () => {}, currentTime: 0 };
      bgm = { play: () => Promise.resolve(), loop: true, volume: 0.3 };
    }

    try {
      highscore = parseInt(localStorage.getItem("sakuraGameHighscoreV2")) || 0; // ã‚­ãƒ¼åã‚’å°‘ã—å¤‰æ›´
    } catch (error) {
      console.log("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“");
    }
    highscoreDisplay.innerText = highscore;

    function createBackgroundParticle() {
      const particle = document.createElement("div");
      particle.className = "bg-particle";
      particle.style.left = Math.random() * window.innerWidth + "px";
      particle.style.width = particle.style.height = (Math.random() * 8 + 4) + "px";
      particle.style.animationDuration = (Math.random() * 10 + 8) + "s";
      document.body.appendChild(particle);
      setTimeout(() => { if (particle.parentNode) particle.remove(); }, 20000);
    }

    function updateCharacterPosition() {
      character.style.left = `${characterX}px`;
    }

    // â˜…â˜…â˜… æœ€å¤§ãƒ¬ãƒ™ãƒ«ã¨æ–°ã—ã„é–¾å€¤ã‚’è€ƒæ…®ã—ãŸãƒ¬ãƒ™ãƒ«è¨ˆç®— â˜…â˜…â˜…
    function calculateLevel() {
      let newCalculatedLevel = 1;
      // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ãŒã©ã®ãƒ¬ãƒ™ãƒ«ã®é–¾å€¤ã‚’è¶…ãˆã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
      for (let i = 0; i < levelThresholds.length; i++) {
        if (score >= levelThresholds[i]) {
          newCalculatedLevel = i + 1; // é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹+1ãŒãƒ¬ãƒ™ãƒ«ã«ãªã‚‹
        } else {
          // ã‚¹ã‚³ã‚¢ãŒæ¬¡ã®é–¾å€¤ã«é”ã—ã¦ã„ãªã‘ã‚Œã°ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
          break;
        }
      }
      return Math.min(newCalculatedLevel, MAX_LEVEL); // å¿µã®ãŸã‚MAX_LEVELã§åˆ¶é™
    }

    function updateScore(points = 1) {
      const previousLevel = level;
      if (isPowerUpActive) points *= 2;
      score += points;
      combo++;
      scoreDisplay.innerText = score;
      comboDisplay.innerText = combo;

      level = calculateLevel(); // æ–°ã—ã„ãƒ¬ãƒ™ãƒ«è¨ˆç®—é–¢æ•°ã‚’å‘¼ã³å‡ºã™
      levelDisplay.innerText = level;

      if (level > previousLevel) { // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ãŸå ´åˆã®ã¿è¡¨ç¤º
        if (level === MAX_LEVEL && previousLevel < MAX_LEVEL) {
          showLevelUp(`MAX LEVEL ${MAX_LEVEL} åˆ°é”!`);
        } else if (level < MAX_LEVEL) {
          showLevelUp(`LEVEL ${level}!`);
        }
        // MAX_LEVELã«åˆ°é”ã—ãŸã‚‰ã€ãã‚Œä»¥é™ã®ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è¡¨ç¤ºã—ãªã„
        // (ã¾ãŸã¯ã€ãƒ¬ãƒ™ãƒ«ã¯å†…éƒ¨çš„ã«ä¸ŠãŒã‚Šç¶šã‘ã‚‹ãŒã€è¡¨ç¤ºã¯MAX_LEVELã®ã¾ã¾ã¨ã„ã†æ–¹æ³•ã‚‚ã‚ã‚‹)
      }


      if (combo > 1) showComboPopup();
      if (combo > maxCombo) maxCombo = combo;
      if (se && typeof se.play === 'function') {
        se.currentTime = 0;
        se.play().catch(err => console.warn("åŠ¹æœéŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
      }
      if (points >= 5) showSpecialEffect();
    }
    function resetCombo() {
      combo = 0;
      comboDisplay.innerText = combo;
    }

    function showComboPopup() {
      comboPopup.textContent = `${combo} COMBO!`;
      comboPopup.style.display = 'block';
      setTimeout(() => { comboPopup.style.display = 'none'; }, 1000);
    }

    // â˜…â˜…â˜… ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—è¡¨ç¤ºé–¢æ•°ã‚’å°‘ã—å¤‰æ›´ (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«) â˜…â˜…â˜…
    function showLevelUp(message = `LEVEL ${level}!`) {
      levelUpEffect.textContent = message;
      levelUpEffect.style.display = 'block';
      setTimeout(() => { levelUpEffect.style.display = 'none'; }, 2000);
    }


    function showSpecialEffect() {
      scoreDisplay.style.transform = 'scale(1.3)';
      scoreDisplay.style.color = '#FFD700';
      setTimeout(() => {
        scoreDisplay.style.transform = 'scale(1)';
        scoreDisplay.style.color = '#5a3d5c';
      }, 500);
    }

    let powerUpTimerId = null;
    function activatePowerUp() {
      if (isPowerUpActive) {
        powerUpEndTime += 10000;
        if (powerUpTimerId) clearInterval(powerUpTimerId);
      } else {
        isPowerUpActive = true;
        powerUpEndTime = Date.now() + 10000;
        character.classList.add('powerup');
        powerEffect.textContent = 'âœ¨ãƒ€ãƒ–ãƒ«ã‚¹ã‚³ã‚¢ä¸­ï¼';
        powerEffect.style.display = 'block';
      }
      powerUpTimerId = setInterval(() => {
        const remaining = Math.ceil((powerUpEndTime - Date.now()) / 1000);
        if (remaining <= 0) {
          clearInterval(powerUpTimerId);
          powerUpTimerId = null;
          deactivatePowerUp();
        } else {
          powerEffect.textContent = `âœ¨ãƒ€ãƒ–ãƒ«ã‚¹ã‚³ã‚¢ä¸­ï¼(${remaining}s)`;
        }
      }, 100);
    }

    function deactivatePowerUp() {
      isPowerUpActive = false;
      character.classList.remove('powerup');
      powerEffect.style.display = 'none';
      if (powerUpTimerId) {
          clearInterval(powerUpTimerId);
          powerUpTimerId = null;
      }
    }

    // â˜…â˜…â˜… ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ â˜…â˜…â˜…
    function createItem() {
      if (timeLeft <= 0) return;

      const item = document.createElement("div");
      const rand = Math.random();
      let itemType = "normal"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

      // --- ç¢ºç‡è¨­å®š ---
      let probBomb = 0;
      if (level >= 2) { // çˆ†å¼¾ã¯ãƒ¬ãƒ™ãƒ«2ã‹ã‚‰
        probBomb = Math.min(0.05 + (level - 2) * 0.03, 0.14); // L2:5%, L3:8%, L4:11%, L5:14%
      }
      const probTimePlus = 0.08; // æ™‚é–“å¢—åŠ ã‚¢ã‚¤ãƒ†ãƒ : 8% (ãƒ¬ãƒ™ãƒ«1ã‹ã‚‰)
      let probPowerUp = 0;
      if (level >= 2) { // ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã¯ãƒ¬ãƒ™ãƒ«2ã‹ã‚‰
          probPowerUp = 0.07; // 7%
      }
      const probGolden = 0.15; // é‡‘: 15%
      const probSpecial = 0.20; // ç‰¹: 20%
      // æ®‹ã‚ŠãŒé€šå¸¸

      // --- ã‚¢ã‚¤ãƒ†ãƒ ã‚¿ã‚¤ãƒ—æ±ºå®š ---
      let cumulativeProb = 0;

      cumulativeProb += probBomb;
      if (rand < cumulativeProb && level >= 2) { // level >=2 æ¡ä»¶ã‚’ã“ã“ã§ã‚‚ç¢ºèª
        itemType = "bomb";
      } else {
        cumulativeProb += probTimePlus;
        if (rand < cumulativeProb) {
          itemType = "timePlus";
        } else {
          cumulativeProb += probPowerUp;
          if (rand < cumulativeProb && level >= 2) { // level >=2 æ¡ä»¶ã‚’ã“ã“ã§ã‚‚ç¢ºèª
             itemType = "powerup";
          } else {
            cumulativeProb += probGolden;
            if (rand < cumulativeProb) {
              itemType = "golden";
            } else {
              cumulativeProb += probSpecial;
              if (rand < cumulativeProb) {
                itemType = "special";
              } else {
                itemType = "normal";
              }
            }
          }
        }
      }


      // --- DOMç”Ÿæˆã¨è¨­å®š ---
      switch(itemType) {
        case "bomb":
          item.className = "bomb";
          item.dataset.type = "bomb";
          item.dataset.points = "-10";
          break;
        case "timePlus": // â˜…â˜…â˜… æ™‚é–“å¢—åŠ ã‚¢ã‚¤ãƒ†ãƒ  â˜…â˜…â˜…
          item.className = "time-plus";
          item.dataset.type = "timePlus";
          // item.dataset.timeValue = "5"; // æ™‚é–“å¢—åŠ é‡ (ä»Šå›ã¯ç›´æ¥å‡¦ç†)
          break;
        case "powerup":
          item.className = "power-up";
          item.dataset.type = "powerup";
          item.dataset.points = "0";
          break;
        case "golden":
          item.className = "petal golden";
          item.dataset.type = "golden";
          item.dataset.points = "5";
          break;
        case "special":
          item.className = "petal special";
          item.dataset.type = "special";
          item.dataset.points = "2";
          break;
        default: // normal
          item.className = "petal";
          item.dataset.type = "normal";
          item.dataset.points = "1";
      }

      item.style.left = Math.random() * (window.innerWidth - (parseInt(item.style.width) || 40)) + "px";
      let animationDuration = Math.max(1.5, (2 + Math.random() * 2) - (level * 0.1));
      item.style.animationDuration = animationDuration + "s";
      document.body.appendChild(item);

      const checkCollision = setInterval(() => {
        if (!item.parentNode || timeLeft <= 0) {
            clearInterval(checkCollision);
            if(item.parentNode) item.remove();
            return;
        }
        const rect1 = item.getBoundingClientRect();
        const rect2 = character.getBoundingClientRect();

        if ( rect1.top < rect2.bottom && rect1.bottom > rect2.top && rect1.left < rect2.right && rect1.right > rect2.left ) {
          const type = item.dataset.type;

          if (type === "bomb") {
            score = Math.max(0, score + parseInt(item.dataset.points)); // dataset.points ã¯ "-10"
            scoreDisplay.innerText = score;
            resetCombo();
            document.body.style.background = '#ff6b6b';
            setTimeout(() => {
              document.body.style.background = 'linear-gradient(135deg, #ffeef5 0%, #ffe8f0 25%, #f8e8ff 50%, #e8f0ff 75%, #f0f8ff 100%)';
            }, 150);
          } else if (type === "timePlus") { // â˜…â˜…â˜… æ™‚é–“å¢—åŠ ã‚¢ã‚¤ãƒ†ãƒ ã®å‡¦ç† â˜…â˜…â˜…
            timeLeft = Math.min(timeLeft + 5, MAX_TIME_LEFT); // 5ç§’ãƒ—ãƒ©ã‚¹ã€ä¸Šé™MAX_TIME_LEFTç§’
            timerDisplay.innerText = timeLeft;
            // æ™‚é–“å¢—åŠ ã®ç‰¹åˆ¥ãªåŠ¹æœéŸ³ã‚„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ã“ã“ã«è¿½åŠ ã—ã¦ã‚‚è‰¯ã„
          } else if (type === "powerup") {
            activatePowerUp();
          } else { // èŠ±ã³ã‚‰ç³»ã‚¢ã‚¤ãƒ†ãƒ 
            updateScore(parseInt(item.dataset.points));
          }
          item.remove();
          clearInterval(checkCollision);
        }
      }, 30);

      setTimeout(() => {
        if (item.parentNode) {
          item.remove();
          if (item.dataset.type !== "bomb" && item.dataset.type !== "powerup" && item.dataset.type !== "timePlus") {
            resetCombo();
          }
        }
        clearInterval(checkCollision);
      }, animationDuration * 1000 + 200);
    }

    let gameTimerId = null;
    let itemSpawnerId = null;

    function startGame() {
      if (bgm && typeof bgm.play === 'function' && bgm.paused) {
        bgm.play().catch(err => console.warn("BGMå†ç”Ÿã«å¤±æ•—:", err));
      }
      itemSpawnerId = setInterval(createItem, getSpawnRate());
      bgParticleInterval = setInterval(createBackgroundParticle, 500);
      gameTimerId = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(gameTimerId);
            clearInterval(itemSpawnerId);
            clearInterval(bgParticleInterval);
            if (powerUpTimerId) clearInterval(powerUpTimerId);
            endGame();
            return;
        }
        timeLeft--;
        timerDisplay.innerText = timeLeft;
        clearInterval(itemSpawnerId); // é›£æ˜“åº¦å¤‰æ›´ã®ãŸã‚ä¸€æ—¦ã‚¯ãƒªã‚¢
        itemSpawnerId = setInterval(createItem, getSpawnRate());
      }, 1000);
    }

    function endGame() {
      if (bgm && typeof bgm.pause === 'function') bgm.pause();
      finalScore.innerText = score;
      finalLevel.innerText = level;
      gameover.style.display = "block";
      if (score > highscore) {
        highscore = score;
        try {
          localStorage.setItem("sakuraGameHighscoreV2", highscore);
          highscoreDisplay.innerText = highscore;
        } catch (error) { console.log("ãƒã‚¤ã‚¹ã‚³ã‚¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
      }
      document.querySelectorAll('.petal, .bomb, .power-up, .time-plus, .bg-particle').forEach(el => el.remove());
      if (returnToSelectBtn) {
        returnToSelectBtn.addEventListener("click", () => {
          window.location.href = "index.html";
        });
      }
    }

    document.addEventListener("keydown", (e) => {
      if (timeLeft <= 0) return;
      let moved = false;
      if (e.key === "ArrowLeft") { characterX -= 30; moved = true; }
      else if (e.key === "ArrowRight") { characterX += 30; moved = true; }
      else if (e.key === " " || e.key === "ArrowUp") { e.preventDefault(); jump(); }
      if (moved) {
        const charRect = character.getBoundingClientRect();
        characterX = Math.max(charRect.width / 2, Math.min(window.innerWidth - (charRect.width / 2), characterX));
        updateCharacterPosition();
      }
    });

    function jump() {
      if (!character.classList.contains("jump") && timeLeft > 0) {
        character.classList.add("jump");
        setTimeout(() => character.classList.remove("jump"), 600);
      }
    }

    character.addEventListener("click", (e) => {
      if (timeLeft <= 0) return;
      e.preventDefault(); jump();
    }, { passive: false });

    const leftBtn = document.createElement("button");
    leftBtn.innerText = "â—€"; leftBtn.className = "control-btn"; leftBtn.style.left = "20px";
    const rightBtn = document.createElement("button");
    rightBtn.innerText = "â–¶"; rightBtn.className = "control-btn"; rightBtn.style.right = "20px";
    document.body.appendChild(leftBtn); document.body.appendChild(rightBtn);

    let moveInterval = null;
    function startMove(direction) {
      if (moveInterval || timeLeft <= 0) return;
      moveInterval = setInterval(() => {
        if (direction === "left") characterX -= 15;
        else if (direction === "right") characterX += 15;
        const charRect = character.getBoundingClientRect();
        characterX = Math.max(charRect.width / 2, Math.min(window.innerWidth - (charRect.width / 2), characterX));
        updateCharacterPosition();
      }, 50);
    }
    function stopMove() { clearInterval(moveInterval); moveInterval = null; }

    leftBtn.addEventListener("touchstart", (e) => { e.preventDefault(); startMove("left"); }, { passive: false });
    rightBtn.addEventListener("touchstart", (e) => { e.preventDefault(); startMove("right"); }, { passive: false });
    document.addEventListener("touchend", (e) => { if (moveInterval) stopMove(); }, { passive: false });
    leftBtn.addEventListener("mousedown", () => startMove("left"));
    rightBtn.addEventListener("mousedown", () => startMove("right"));
    document.addEventListener("mouseup", stopMove);

    let touchStartX = null; let touchStartY = null; const swipeThreshold = 30;
    document.addEventListener("touchstart", (e) => {
      if (timeLeft <= 0 || e.target.classList.contains('control-btn')) return;
      touchStartX = e.changedTouches[0].clientX; touchStartY = e.changedTouches[0].clientY;
    }, { passive: true });
    document.addEventListener("touchmove", (e) => {
      if (timeLeft <= 0 || !touchStartX || e.target.classList.contains('control-btn')) return;
      let currentX = e.changedTouches[0].clientX; let deltaX = currentX - touchStartX;
      const charRect = character.getBoundingClientRect();
      const minCharX = charRect.width / 2; const maxCharX = window.innerWidth - (charRect.width / 2);
      characterX += deltaX * 0.6;
      characterX = Math.max(minCharX, Math.min(maxCharX, characterX));
      updateCharacterPosition(); touchStartX = currentX;
    }, { passive: true });
    document.addEventListener("touchend", (e) => {
      if (timeLeft <= 0 || touchStartX === null || touchStartY === null || e.target.classList.contains('control-btn')) {
        touchStartX = null; touchStartY = null; return;
      }
      const deltaX = e.changedTouches[0].clientX - touchStartX; const deltaY = e.changedTouches[0].clientY - touchStartY;
      if (Math.abs(deltaY) > Math.abs(deltaX) && deltaY < -swipeThreshold) jump();
      touchStartX = null; touchStartY = null;
    }, { passive: true });

    window.addEventListener('resize', () => {
      const charRect = character.getBoundingClientRect();
      characterX = Math.max(charRect.width / 2, Math.min(window.innerWidth - (charRect.width / 2), characterX));
      updateCharacterPosition();
    });

    updateCharacterPosition();
    function attemptBgmPlay() {
      if (bgm && typeof bgm.play === 'function' && bgm.paused) {
        bgm.play().then(() => {
          document.body.removeEventListener('click', attemptBgmPlay);
          document.body.removeEventListener('touchstart', attemptBgmPlay);
        }).catch(error => { console.warn("BGMã®å†ç”Ÿè©¦è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ:", error); });
      } else if (bgm && !bgm.paused) {
        document.body.removeEventListener('click', attemptBgmPlay);
        document.body.removeEventListener('touchstart', attemptBgmPlay);
      }
    }
    document.body.addEventListener('click', attemptBgmPlay, {once: true});
    document.body.addEventListener('touchstart', attemptBgmPlay, {once: true});

    startGame();
  </script>
</body>
</html>
