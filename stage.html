<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¡œèˆã†ç©ºã‚­ãƒ£ãƒƒãƒã‚²ãƒ¼ãƒ  - ç©¶æ¥µç‰ˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
    body {
      width: 100vw; height: 100vh; overflow: hidden; position: relative;
      background: linear-gradient(135deg, #ffeef5 0%, #ffe8f0 25%, #f8e8ff 50%, #e8f0ff 75%, #f0f8ff 100%);
      font-family: 'Noto Sans JP', sans-serif;
      touch-action: manipulation; -webkit-overflow-scrolling: touch;
      display: flex; /* â˜…â˜…â˜… game-container ã‚’ä¸­å¤®å¯„ã›ã™ã‚‹ãŸã‚ */
      justify-content: center; /* â˜…â˜…â˜… game-container ã‚’ä¸­å¤®å¯„ã›ã™ã‚‹ãŸã‚ */
      align-items: center; /* â˜…â˜…â˜… game-container ã‚’ä¸­å¤®å¯„ã›ã™ã‚‹ãŸã‚ (é«˜ã•100vhãªã‚‰ä¸è¦ã‹ã‚‚) */
    }
    .bg-particle { position: absolute; background: rgba(255, 182, 193, 0.3); border-radius: 50%; pointer-events: none; animation: float-bg linear infinite; z-index: 0; }
    @keyframes float-bg { 0% { transform: translateY(100vh) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-100px) rotate(360deg); opacity: 0; } }

    /* â˜…â˜…â˜… ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« â˜…â˜…â˜… */
    #game-container {
      position: relative; /* å­è¦ç´ ã®çµ¶å¯¾é…ç½®ã®åŸºæº– */
      width: 100%;
      max-width: 480px; /* ã‚¹ãƒãƒ›ç¸¦ç”»é¢ã«è¿‘ã„æœ€å¤§å¹… (ã“ã®å€¤ã‚’èª¿æ•´ã—ã¦ãŠå¥½ã¿ã®å¹…ã«) */
      height: 100vh;    /* ç”»é¢ã®é«˜ã•å…¨ä½“ã‚’ä½¿ç”¨ */
      /* margin: 0 auto; /* bodyãŒflexã§ãªã„å ´åˆã¯ã“ã‚Œã§ä¸­å¤®å¯„ã› */
      overflow: hidden; /* ã‚¢ã‚¤ãƒ†ãƒ ãŒã“ã®ç¯„å›²å¤–ã«ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
      /* background: rgba(0,0,0,0.05); */ /* ãƒ‡ãƒãƒƒã‚°ç”¨ã«ç¯„å›²ã‚’å¯è¦–åŒ– */
    }

    #character {
      position: absolute; /* game-containeråŸºæº– */
      bottom: 80px;
      left: 50%; /* game-container ã®ä¸­å¤® */
      transform: translateX(-50%);
      max-height: 25vh; max-width: 120px; height: auto;
      z-index: 5; filter: drop-shadow(2px 4px 8px rgba(0,0,0,0.2));
    }
    #character.jump { animation: jump 0.6s ease; }
    #character.powerup {
      filter: drop-shadow(0 0 15px #FFD700) drop-shadow(2px 4px 8px rgba(0,0,0,0.2));
      transform: translateX(-50%) scale(1.1);
      transition: transform 0.2s ease-out, filter 0.2s ease-out;
    }
    @keyframes jump { 0% { transform: translateX(-50%) translateY(0); } 30% { transform: translateX(-50%) translateY(-60px); } 60% { transform: translateX(-50%) translateY(-60px); } 100% { transform: translateX(-50%) translateY(0); } }
    .petal { position: absolute; width: 35px; height: 35px; background-image: url('petal.png'); background-color: transparent; background-repeat: no-repeat; background-position: center; background-size: contain; pointer-events: none; animation: fall linear; z-index: 1; filter: drop-shadow(0 0 2px rgba(220, 20, 60, 0.3)); }
    .petal.special { position: absolute; width: 40px; height: 40px; background: radial-gradient(circle, #FFD700 0%, #FFA500 50%, #FF69B4 100%); filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8)); animation: fall-special linear; border-radius:50%; }
    .petal.golden { position: absolute; width: 45px; height: 45px; background: radial-gradient(circle, #FFD700 0%, #FFFF00 30%, #FFA500 70%, #FF4500 100%); filter: drop-shadow(0 0 15px rgba(255, 215, 0, 1)) drop-shadow(0 0 8px rgba(255, 255, 255, 0.8)); animation: fall-golden linear; border: 2px solid rgba(255, 255, 255, 0.8); border-radius:50%; }
    .bomb { position: absolute; width: 40px; height: 40px; background: radial-gradient(circle, #FF0000 0%, #8B0000 70%, #000000 100%); border-radius: 50%; filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.8)); animation: fall-bomb linear; }
    .bomb::before { content: 'ğŸ’£'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 25px; animation: bomb-pulse 0.5s infinite alternate; }
    @keyframes bomb-pulse { 0% { transform: translate(-50%, -50%) scale(1); } 100% { transform: translate(-50%, -50%) scale(1.2); } }
    .power-up { position: absolute; width: 45px; height: 45px; background: linear-gradient(45deg, #9370DB, #4169E1, #00CED1, #32CD32, #FFD700); border-radius: 50%; filter: drop-shadow(0 0 15px rgba(147, 112, 219, 0.8)); animation: fall-powerup linear; animation-name: fall-powerup, rainbow-rotate; animation-duration: inherit, 1s; animation-iteration-count: 1, infinite; animation-timing-function: linear, ease-in-out; }
    .power-up::before { content: 'â­'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 25px; animation: star-spin 2s linear infinite; }
    .time-plus { position: absolute; width: 40px; height: 40px; background: radial-gradient(circle, #fafad2 0%, #eee8aa 50%, #daa520 100%); border-radius: 50%; filter: drop-shadow(0 0 8px rgba(218, 165, 32, 0.7)); animation: fall-time-plus linear; }
    .time-plus::before { content: 'âŒ›ï¸'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 25px; animation: time-pulse 1.5s ease-in-out infinite alternate; }
    @keyframes time-pulse { 0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0.7; } 50% { transform: translate(-50%, -50%) scale(1.1) rotate(10deg); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0.7; } }
    @keyframes star-spin { 0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); } 50% { transform: translate(-50%, -50%) rotate(180deg) scale(1.2); } 100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); } }
    @keyframes rainbow-rotate { 0% { filter: drop-shadow(0 0 15px rgba(147, 112, 219, 0.8)) hue-rotate(0deg); } 100% { filter: drop-shadow(0 0 15px rgba(147, 112, 219, 0.8)) hue-rotate(360deg); } }
    @keyframes fall { 0% { transform: translateY(-60px) rotateZ(0deg) rotateX(0deg) scale(0.9); opacity: 0.5; } 25% { transform: translateY(25vh) rotateZ(180deg) rotateX(45deg) scale(1); opacity: 1; } 50% { transform: translateY(50vh) rotateZ(360deg) rotateX(-30deg) scale(1.1); opacity: 1; } 75% { transform: translateY(75vh) rotateZ(540deg) rotateX(60deg) scale(1); opacity: 0.8; } 100% { transform: translateY(105vh) rotateZ(720deg) rotateX(0deg) scale(0.8); opacity: 0; } }
    @keyframes fall-special { 0% { transform: translateY(-50px) rotate(0deg) scale(0.8); opacity: 0.8; } 25% { opacity: 1; transform: translateY(25vh) rotate(90deg) scale(1.2); } 50% { transform: translateY(50vh) rotate(180deg) scale(1.3); } 75% { transform: translateY(75vh) rotate(270deg) scale(1.1); } 100% { transform: translateY(100vh) rotate(360deg) scale(1); opacity: 0.9; } }
    @keyframes fall-golden { 0% { transform: translateY(-50px) rotate(0deg) scale(0.9); opacity: 0.9; } 25% { opacity: 1; transform: translateY(25vh) rotate(120deg) scale(1.3); } 50% { transform: translateY(50vh) rotate(240deg) scale(1.4); } 75% { transform: translateY(75vh) rotate(300deg) scale(1.2); } 100% { transform: translateY(100vh) rotate(480deg) scale(1); opacity: 1; } }
    @keyframes fall-bomb { 0% { transform: translateY(-50px) rotate(0deg) scale(1); opacity: 1; } 30% { transform: translateY(30vh) rotate(-20deg) scale(1.05); } 60% { transform: translateY(60vh) rotate(15deg) scale(1.1); } 100% { transform: translateY(100vh) rotate(10deg) scale(1); opacity: 1; } }
    @keyframes fall-powerup { 0% { transform: translateY(-50px) scale(0.8); opacity: 0.8; } 25% { opacity: 1; transform: translateY(25vh) scale(1.1); } 50% { transform: translateY(50vh) scale(1.2); } 75% { transform: translateY(75vh) scale(1.1); } 100% { transform: translateY(100vh) scale(1); opacity: 1; } }
    @keyframes fall-time-plus { 0% { transform: translateY(-50px) translateX(0px) rotate(0deg) scale(0.9); opacity: 0.7;} 25% { opacity: 1; transform: translateY(25vh) translateX(10px) rotate(5deg) scale(1);} 50% { transform: translateY(50vh) translateX(-10px) rotate(-5deg) scale(1.1);} 75% { transform: translateY(75vh) translateX(5px) rotate(2deg) scale(1);} 100% { transform: translateY(100vh) translateX(0px) rotate(0deg) scale(0.9); opacity: 1;} }
    
    /* UIè¦ç´ ã¯ fixed ã®ã¾ã¾ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆåŸºæº–ã§é…ç½® */
    #scoreboard { position: fixed; top: 15px; right: 20px; font-size: 14px; font-weight: bold; color: #5a3d5c; background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 240, 250, 0.9) 100%); padding: 15px 20px; border-radius: 20px; z-index: 100; /* game-container ã‚ˆã‚Šæ‰‹å‰ */ line-height: 1.6; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(255, 105, 180, 0.2); border: 2px solid rgba(255, 182, 193, 0.4); backdrop-filter: blur(10px); min-width: 180px; }
    #level-display { position: fixed; top: 15px; left: 20px; font-size: 16px; font-weight: bold; color: #5a3d5c; background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(240, 248, 255, 0.9) 100%); padding: 12px 18px; border-radius: 15px; z-index: 100; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(65, 105, 225, 0.2); border: 2px solid rgba(100, 149, 237, 0.3); backdrop-filter: blur(5px); }
    .combo-display { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; font-weight: bold; color: #FFD700; background: rgba(0, 0, 0, 0.8); padding: 10px 20px; border-radius: 15px; z-index: 105; animation: combo-pop 1s ease-out; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); }
    @keyframes combo-pop { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
    
    #gameover { /* game-container å†…ã«é…ç½®ã™ã‚‹ãŸã‚ position: absolute ã« */
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 28px; font-weight: bold; background: linear-gradient(145deg, rgba(0,0,0,0.9), rgba(50,50,50,0.8));
      color: white; padding: 30px 50px; border-radius: 20px; display: none; z-index: 20; text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 2px solid rgba(255, 255, 255, 0.2);
      width: 80%; /* game-container ã«å¯¾ã™ã‚‹å¹… */
      max-width: 400px; /* gameoverè¡¨ç¤ºè‡ªä½“ã®æœ€å¤§å¹… */
    }
    #return-to-select-btn { background-color: #f08080; color: white; border: none; padding: 12px 25px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin-top: 25px; cursor: pointer; border-radius: 8px; transition: background-color 0.3s ease; }
    #return-to-select-btn:hover { background-color: #cd5c5c; }
    .control-btn { position: fixed; bottom: 15px; width: 55px; height: 55px; font-size: 22px; border-radius: 50%; border: none; background: linear-gradient(145deg, rgba(255, 182, 193, 0.9) 0%, rgba(255, 105, 180, 0.8) 100%); color: white; z-index: 100; touch-action: manipulation; -webkit-tap-highlight-color: transparent; cursor: pointer; box-shadow: 0 6px 18px rgba(255, 105, 180, 0.4), 0 3px 6px rgba(0, 0, 0, 0.2); border: 2px solid rgba(255, 255, 255, 0.4); transition: all 0.2s ease; }
    .control-btn:active { transform: scale(0.95); box-shadow: 0 3px 9px rgba(255, 105, 180, 0.4), 0 1px 3px rgba(0, 0, 0, 0.2); }
    .power-effect { position: fixed; bottom: 150px; left: 20px; background: linear-gradient(45deg, #9370DB, #4169E1); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold; z-index: 100; display: none; animation: power-glow 0.5s ease-in-out infinite alternate; }
    @keyframes power-glow { 0% { box-shadow: 0 0 10px rgba(147, 112, 219, 0.8); } 100% { box-shadow: 0 0 20px rgba(147, 112, 219, 1); } }
    @media (max-height: 600px) { #character { bottom: 90px; max-height: 20vh; } .control-btn { bottom: 10px; width: 50px; height: 50px; font-size: 20px; } #scoreboard, #level-display { font-size: 12px; padding: 10px 15px; } }
    @media (max-height: 500px) { #character { bottom: 100px; max-height: 18vh; } }
    .level-up-effect { position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; font-weight: bold; color: #FFD700; background: linear-gradient(45deg, rgba(255, 215, 0, 0.9), rgba(255, 140, 0, 0.8)); padding: 20px 40px; border-radius: 20px; z-index: 105; display: none; animation: level-up-animation 2s ease-out; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); border: 3px solid rgba(255, 255, 255, 0.8); }
    @keyframes level-up-animation { 0% { transform: translate(-50%, -50%) scale(0.5) rotate(-10deg); opacity: 0; } 30% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); opacity: 1; } 70% { transform: translate(-50%, -50%) scale(1.1) rotate(-2deg); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0; } }
  </style>
</head>
<body>
  <div id="game-container">
    <img id="character" src="" alt="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼">
    <div id="gameover">
      <div>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</div>
      <div style="font-size: 18px; margin-top: 10px;">
        æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="final-score">0</span><br>
        åˆ°é”ãƒ¬ãƒ™ãƒ«: <span id="final-level">1</span>
      </div>
      <button id="return-to-select-btn">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã«æˆ»ã‚‹</button>
    </div>
    <div class="combo-display" id="combo-display"></div>
    <div class="level-up-effect" id="level-up-effect"></div>
  </div>

  <div id="scoreboard"> ã‚¹ã‚³ã‚¢: <span id="score">0</span><br> ãƒã‚¤ã‚¹ã‚³ã‚¢: <span id="highscore">0</span><br> æ®‹ã‚Š: <span id="timer">60</span>ç§’<br> ã‚³ãƒ³ãƒœ: <span id="combo">0</span> </div>
  <div id="level-display"> ãƒ¬ãƒ™ãƒ«: <span id="level">1</span> </div>
  <div class="power-effect" id="power-effect"></div>


  <script>
    document.addEventListener('contextmenu', e => { e.preventDefault(); return false; }, { passive: false });
    document.addEventListener('selectstart', e => { e.preventDefault(); return false; }, { passive: false });
    document.addEventListener('dragstart', e => { e.preventDefault(); return false; }, { passive: false });

    // â˜…â˜…â˜… game-container ã‚’å–å¾— â˜…â˜…â˜…
    const gameContainer = document.getElementById("game-container");
    const character = document.getElementById("character");
    // (ä»–ã®è¦ç´ å–å¾—ã¯å¤‰æ›´ãªã—)
    const scoreDisplay = document.getElementById("score");
    const highscoreDisplay = document.getElementById("highscore");
    const timerDisplay = document.getElementById("timer");
    const levelDisplay = document.getElementById("level");
    const comboPopup = document.getElementById("combo-display");
    const powerEffect = document.getElementById("power-effect");
    const levelUpEffect = document.getElementById("level-up-effect");
    const gameover = document.getElementById("gameover"); // game-containerå†…ã«ç§»å‹•æ¸ˆã¿
    const finalScore = document.getElementById("final-score");
    const finalLevel = document.getElementById("final-level");
    const returnToSelectBtn = document.getElementById("return-to-select-btn");


    const selectedImageFile = localStorage.getItem("selectedImage");
    const selectedCharName = localStorage.getItem("selectedName");

    if (selectedImageFile && selectedCharName) {
      character.src = selectedImageFile;
      character.alt = selectedCharName;
    } else {
      character.src = "shaoran_web.PNG";
      character.alt = "ã‚·ãƒ£ã‚ªãƒ©ãƒ³";
    }

    let score = 0; let highscore = 0; let timeLeft = 60;
    const MAX_TIME_LEFT = 90; const MAX_LEVEL = 5; let level = 1;
    const levelThresholds = [0, 30, 80, 150, 250];
    let combo = 0; let maxCombo = 0; let itemSpawnerId; let bgParticleInterval;
    let isPowerUpActive = false; let powerUpEndTime = 0;
    // â˜…â˜…â˜… characterX ã®åˆæœŸå€¤ã‚’ gameContainer ã®å¹…ã‚’åŸºæº–ã« â˜…â˜…â˜…
    let characterX; // åˆæœŸåŒ–ã¯ startGame å‰ã€ã¾ãŸã¯ gameContainer ã®å¹…ãŒç¢ºå®šã—ã¦ã‹ã‚‰

    let se, bgm, seTimePlus, seBomb, sePowerUp;
    try {
      se = new Audio("kirarin.mp3"); bgm = new Audio("bgm.mp3");
      seTimePlus = new Audio("tm.mp3"); seBomb = new Audio("bom.mp3"); sePowerUp = new Audio("st.mp3");
      bgm.loop = true; bgm.volume = 0.3;
    } catch (error) {
      console.error("ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®åˆæœŸåŒ–ã«å¤±æ•—: ", error);
      se = { play: () => {}, currentTime: 0 }; bgm = { play: () => Promise.resolve(), loop: true, volume: 0.3 };
      seTimePlus = { play: () => {}, currentTime: 0 }; seBomb = { play: () => {}, currentTime: 0 }; sePowerUp = { play: () => {}, currentTime: 0 };
    }
    try { highscore = parseInt(localStorage.getItem("sakuraGameHighscoreV2")) || 0; } catch (error) { }
    highscoreDisplay.innerText = highscore;

    function createBackgroundParticle() {
      const particle = document.createElement("div"); particle.className = "bg-particle";
      particle.style.left = Math.random() * window.innerWidth + "px"; // èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã¯ç”»é¢å…¨ä½“
      particle.style.width = particle.style.height = (Math.random() * 8 + 4) + "px";
      particle.style.animationDuration = (Math.random() * 10 + 8) + "s";
      document.body.appendChild(particle); // bodyç›´ä¸‹ã«è¿½åŠ 
      setTimeout(() => { if (particle.parentNode) particle.remove(); }, 20000);
    }
    function updateCharacterPosition() { character.style.left = `${characterX}px`; }
    function calculateLevel() { let newCalculatedLevel = 1; for (let i = 0; i < levelThresholds.length; i++) { if (score >= levelThresholds[i]) { newCalculatedLevel = i + 1; } else { break; } } return Math.min(newCalculatedLevel, MAX_LEVEL); }
    function getSpawnRate() { return Math.max(150, 700 - (level * 40)); }
    function updateScore(points = 1) { const previousLevel = level; if (isPowerUpActive) points *= 2; score += points; combo++; scoreDisplay.innerText = score; comboDisplay.innerText = combo; level = calculateLevel(); levelDisplay.innerText = level; if (level > previousLevel) { if (level === MAX_LEVEL && previousLevel < MAX_LEVEL) { showLevelUp(`MAX LEVEL ${MAX_LEVEL} åˆ°é”!`); } else if (level < MAX_LEVEL) { showLevelUp(`LEVEL ${level}!`); } } if (combo > 1) showComboPopup(); if (combo > maxCombo) maxCombo = combo; if (se && typeof se.play === 'function') { se.currentTime = 0; se.play().catch(err => console.warn("kirarin.mp3 å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err)); } if (points >= 5) showSpecialEffect(); }
    function resetCombo() { combo = 0; comboDisplay.innerText = combo; }
    function showComboPopup() { comboPopup.textContent = `${combo} COMBO!`; comboPopup.style.display = 'block'; setTimeout(() => { comboPopup.style.display = 'none'; }, 1000); }
    function showLevelUp(message = `LEVEL ${level}!`) { levelUpEffect.textContent = message; levelUpEffect.style.display = 'block'; setTimeout(() => { levelUpEffect.style.display = 'none'; }, 2000); }
    function showSpecialEffect() { scoreDisplay.style.transform = 'scale(1.3)'; scoreDisplay.style.color = '#FFD700'; setTimeout(() => { scoreDisplay.style.transform = 'scale(1)'; scoreDisplay.style.color = '#5a3d5c'; }, 500); }
    let powerUpTimerId = null;
    function activatePowerUp() { if (isPowerUpActive) { powerUpEndTime += 10000; if (powerUpTimerId) clearInterval(powerUpTimerId); } else { isPowerUpActive = true; powerUpEndTime = Date.now() + 10000; character.classList.add('powerup'); powerEffect.textContent = 'âœ¨ãƒ€ãƒ–ãƒ«ã‚¹ã‚³ã‚¢ä¸­ï¼'; powerEffect.style.display = 'block'; } powerUpTimerId = setInterval(() => { const remaining = Math.ceil((powerUpEndTime - Date.now()) / 1000); if (remaining <= 0) { clearInterval(powerUpTimerId); powerUpTimerId = null; deactivatePowerUp(); } else { powerEffect.textContent = `âœ¨ãƒ€ãƒ–ãƒ«ã‚¹ã‚³ã‚¢ä¸­ï¼(${remaining}s)`; } }, 100); }
    function deactivatePowerUp() { isPowerUpActive = false; character.classList.remove('powerup'); powerEffect.style.display = 'none'; if (powerUpTimerId) { clearInterval(powerUpTimerId); powerUpTimerId = null; } }

    function createItem() {
      if (timeLeft <= 0) return;
      const item = document.createElement("div");
      const rand = Math.random(); let itemType = "normal";
      let probBomb = 0; if (level >= 2) { probBomb = Math.min(0.05 + (level - 2) * 0.03, 0.14); }
      const probTimePlus = 0.08; let probPowerUp = 0; if (level >= 2) { probPowerUp = 0.07; }
      const probGolden = 0.15; const probSpecial = 0.20; let cumulativeProb = 0;
      cumulativeProb += probBomb; if (rand < cumulativeProb && level >= 2) { itemType = "bomb"; }
      else { cumulativeProb += probTimePlus; if (rand < cumulativeProb) { itemType = "timePlus"; }
      else { cumulativeProb += probPowerUp; if (rand < cumulativeProb && level >= 2) { itemType = "powerup"; }
      else { cumulativeProb += probGolden; if (rand < cumulativeProb) { itemType = "golden"; }
      else { cumulativeProb += probSpecial; if (rand < cumulativeProb) { itemType = "special"; }
      else { itemType = "normal"; }}}}}

      switch(itemType) {
        case "bomb": item.className = "bomb"; item.dataset.type = "bomb"; item.dataset.points = "-10"; break;
        case "timePlus": item.className = "time-plus"; item.dataset.type = "timePlus"; break;
        case "powerup": item.className = "power-up"; item.dataset.type = "powerup"; item.dataset.points = "0"; break;
        case "golden": item.className = "petal golden"; item.dataset.type = "golden"; item.dataset.points = "5"; break;
        case "special": item.className = "petal special"; item.dataset.type = "special"; item.dataset.points = "2"; break;
        default: item.className = "petal"; item.dataset.type = "normal"; item.dataset.points = "1";
      }

      // â˜…â˜…â˜… ã‚¢ã‚¤ãƒ†ãƒ ã®å‡ºç¾ä½ç½®ã‚’ gameContainer ã®å¹…åŸºæº–ã« â˜…â˜…â˜…
      const itemWidth = parseInt(getComputedStyle(item).width) || 40; // ã‚¢ã‚¤ãƒ†ãƒ ã®å®Ÿéš›ã®å¹…ã‚’å–å¾—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ40
      item.style.left = Math.random() * (gameContainer.offsetWidth - itemWidth) + "px";
      let animationDuration = Math.max(1.5, (2 + Math.random() * 2) - (level * 0.1));
      item.style.animationDuration = animationDuration + "s";
      // â˜…â˜…â˜… ã‚¢ã‚¤ãƒ†ãƒ ã‚’ gameContainer ã«è¿½åŠ  â˜…â˜…â˜…
      gameContainer.appendChild(item);

      const checkCollision = setInterval(() => {
        if (!item.parentNode || timeLeft <= 0) { clearInterval(checkCollision); if(item.parentNode) item.remove(); return; }
        const rect1 = item.getBoundingClientRect(); const rect2 = character.getBoundingClientRect();
        if ( rect1.top < rect2.bottom && rect1.bottom > rect2.top && rect1.left < rect2.right && rect1.right > rect2.left ) {
          const type = item.dataset.type;
          if (type === "bomb") { score = Math.max(0, score + parseInt(item.dataset.points)); scoreDisplay.innerText = score; resetCombo(); if (seBomb && typeof seBomb.play === 'function') { seBomb.currentTime = 0; seBomb.play().catch(err => console.warn("bom.mp3 å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));} document.body.style.background = '#ff6b6b'; setTimeout(() => { document.body.style.background = 'linear-gradient(135deg, #ffeef5 0%, #ffe8f0 25%, #f8e8ff 50%, #e8f0ff 75%, #f0f8ff 100%)'; }, 150); }
          else if (type === "timePlus") { timeLeft = Math.min(timeLeft + 5, MAX_TIME_LEFT); timerDisplay.innerText = timeLeft; if (seTimePlus && typeof seTimePlus.play === 'function') { seTimePlus.currentTime = 0; seTimePlus.play().catch(err => console.warn("tm.mp3 å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));} }
          else if (type === "powerup") { if (sePowerUp && typeof sePowerUp.play === 'function') { sePowerUp.currentTime = 0; sePowerUp.play().catch(err => console.warn("st.mp3 å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));} activatePowerUp(); }
          else { updateScore(parseInt(item.dataset.points)); }
          item.remove(); clearInterval(checkCollision);
        }
      }, 30);
      setTimeout(() => { if (item.parentNode) { item.remove(); if (item.dataset.type !== "bomb" && item.dataset.type !== "powerup" && item.dataset.type !== "timePlus") { resetCombo(); } } clearInterval(checkCollision); }, animationDuration * 1000 + 200);
    }

    let gameTimerId = null;
    function startGame() {
      // â˜…â˜…â˜… characterX ã®åˆæœŸåŒ–ã‚’ã“ã“ã§è¡Œã† (gameContainer ã®å¹…ãŒç¢ºå®šã—ãŸå¾Œ) â˜…â˜…â˜…
      characterX = gameContainer.offsetWidth / 2;
      updateCharacterPosition(); // åˆæœŸä½ç½®ã‚’ã‚»ãƒƒãƒˆ

      if (bgm && typeof bgm.play === 'function' && bgm.paused) { bgm.play().catch(err => console.warn("BGMå†ç”Ÿã«å¤±æ•—:", err)); }
      itemSpawnerId = setInterval(createItem, getSpawnRate());
      bgParticleInterval = setInterval(createBackgroundParticle, 500); // èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã¯bodyã«è¿½åŠ ã•ã‚Œã‚‹ã®ã§ã“ã®ã¾ã¾
      gameTimerId = setInterval(() => {
        if (timeLeft <= 0) { clearInterval(gameTimerId); clearInterval(itemSpawnerId); clearInterval(bgParticleInterval); if (powerUpTimerId) clearInterval(powerUpTimerId); endGame(); return; }
        timeLeft--; timerDisplay.innerText = timeLeft;
        clearInterval(itemSpawnerId); itemSpawnerId = setInterval(createItem, getSpawnRate());
      }, 1000);
    }

    function endGame() {
      if (bgm && typeof bgm.pause === 'function') bgm.pause();
      finalScore.innerText = score; finalLevel.innerText = level; gameover.style.display = "block";
      if (score > highscore) { highscore = score; try { localStorage.setItem("sakuraGameHighscoreV2", highscore); highscoreDisplay.innerText = highscore; } catch (error) { } }
      // â˜…â˜…â˜… gameContainer å†…ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ â˜…â˜…â˜…
      gameContainer.querySelectorAll('.petal, .bomb, .power-up, .time-plus').forEach(el => el.remove());
      document.querySelectorAll('.bg-particle').forEach(el => el.remove()); // èƒŒæ™¯ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚‚å‰Šé™¤

      if (returnToSelectBtn) { returnToSelectBtn.addEventListener("click", () => { window.location.href = "index.html"; }); }
    }

    document.addEventListener("keydown", (e) => {
      if (timeLeft <= 0) return; let moved = false;
      const charWidth = character.offsetWidth || parseInt(getComputedStyle(character).width) || 120; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å¹…ã‚’å–å¾—
      if (e.key === "ArrowLeft") { characterX -= 30; moved = true; }
      else if (e.key === "ArrowRight") { characterX += 30; moved = true; }
      else if (e.key === " " || e.key === "ArrowUp") { e.preventDefault(); jump(); }
      if (moved) {
        // â˜…â˜…â˜… ç§»å‹•ç¯„å›²ã‚’ gameContainer ã®å¹…åŸºæº–ã« â˜…â˜…â˜…
        characterX = Math.max(charWidth / 2, Math.min(gameContainer.offsetWidth - (charWidth / 2), characterX));
        updateCharacterPosition();
      }
    });
    function jump() { if (!character.classList.contains("jump") && timeLeft > 0) { character.classList.add("jump"); setTimeout(() => character.classList.remove("jump"), 600); } }
    character.addEventListener("click", (e) => { if (timeLeft <= 0) return; e.preventDefault(); jump(); }, { passive: false });

    const leftBtn = document.createElement("button"); leftBtn.innerText = "â—€"; leftBtn.className = "control-btn"; leftBtn.style.left = "20px";
    const rightBtn = document.createElement("button"); rightBtn.innerText = "â–¶"; rightBtn.className = "control-btn"; rightBtn.style.right = "20px";
    document.body.appendChild(leftBtn); document.body.appendChild(rightBtn); // æ“ä½œãƒœã‚¿ãƒ³ã¯ body ç›´ä¸‹ã§ fixed

    let moveInterval = null;
    function startMove(direction) {
      if (moveInterval || timeLeft <= 0) return;
      const charWidth = character.offsetWidth || parseInt(getComputedStyle(character).width) || 120;
      moveInterval = setInterval(() => {
        if (direction === "left") characterX -= 15; else if (direction === "right") characterX += 15;
        // â˜…â˜…â˜… ç§»å‹•ç¯„å›²ã‚’ gameContainer ã®å¹…åŸºæº–ã« â˜…â˜…â˜…
        characterX = Math.max(charWidth / 2, Math.min(gameContainer.offsetWidth - (charWidth / 2), characterX));
        updateCharacterPosition();
      }, 30);
    }
    function stopMove() { clearInterval(moveInterval); moveInterval = null; }

    leftBtn.addEventListener("touchstart", (e) => { e.preventDefault(); startMove("left"); }, { passive: false });
    rightBtn.addEventListener("touchstart", (e) => { e.preventDefault(); startMove("right"); }, { passive: false });
    document.addEventListener("touchend", (e) => { if (moveInterval) stopMove(); }, { passive: false });
    leftBtn.addEventListener("mousedown", () => startMove("left"));
    rightBtn.addEventListener("mousedown", () => startMove("right"));
    document.addEventListener("mouseup", stopMove);

    let touchStartX = null; let touchStartY = null; const swipeThreshold = 30;
    document.addEventListener("touchstart", (e) => {
      if (timeLeft <= 0 || e.target.classList.contains('control-btn')) return;
      // ã‚¹ãƒ¯ã‚¤ãƒ—æ“ä½œã‚‚ gameContainer å†…ã§ã®æ“ä½œã‚’ä¸»ã¨ã™ã‚‹ã‹æ¤œè¨
      // ãŸã ã—ã€ç¾çŠ¶ã¯ç”»é¢å…¨ä½“ã§ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’æ¤œçŸ¥
      touchStartX = e.changedTouches[0].clientX; touchStartY = e.changedTouches[0].clientY;
    }, { passive: true });

    document.addEventListener("touchmove", (e) => {
      if (timeLeft <= 0 || !touchStartX || e.target.classList.contains('control-btn')) return;
      let currentX = e.changedTouches[0].clientX;
      // ã‚¹ãƒ¯ã‚¤ãƒ—ã«ã‚ˆã‚‹Xåº§æ¨™ã®å¤‰æ›´ã‚’ gameContainer ã®ç¯„å›²ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹æ¤œè¨
      // ç¾åœ¨ã¯ window.innerWidth åŸºæº–ã® characterX ã‚’æ›´æ–°ã—ã¦ã„ã‚‹
      // gameContainer ãŒä¸­å¤®å¯„ã›ã•ã‚Œã¦ã„ã‚‹å ´åˆã€touchstartX, currentX ã‚‚ gameContainer å†…ã®ç›¸å¯¾åº§æ¨™ã«å¤‰æ›ã—ãŸæ–¹ãŒæ­£ç¢º
      // ç°¡å˜ãªå¯¾å¿œã¨ã—ã¦ã¯ã€characterX ã®ç§»å‹•é‡è‡ªä½“ã¯ãã®ã¾ã¾ã«ã—ã€å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã§ gameContainer ã®å¹…ã‚’ä½¿ã†
      let deltaX = currentX - touchStartX;
      characterX += deltaX * 0.3; // ã‚¹ãƒ¯ã‚¤ãƒ—æ„Ÿåº¦èª¿æ•´

      const charWidth = character.offsetWidth || parseInt(getComputedStyle(character).width) || 120;
      characterX = Math.max(charWidth / 2, Math.min(gameContainer.offsetWidth - (charWidth / 2), characterX));
      updateCharacterPosition();
      touchStartX = currentX; // ã‚¹ãƒ¯ã‚¤ãƒ—ã®å§‹ç‚¹ã‚’æ›´æ–°ã—ç¶šã‘ã‚‹ã“ã¨ã§ã€ãƒ‰ãƒ©ãƒƒã‚°ã®ã‚ˆã†ãªæ“ä½œæ„Ÿã«
    }, { passive: true });

    document.addEventListener("touchend", (e) => {
      if (timeLeft <= 0 || touchStartX === null || touchStartY === null || e.target.classList.contains('control-btn')) {
        touchStartX = null; touchStartY = null; return;
      }
      const deltaX = e.changedTouches[0].clientX - touchStartX; const deltaY = e.changedTouches[0].clientY - touchStartY;
      if (Math.abs(deltaY) > Math.abs(deltaX) && deltaY < -swipeThreshold) jump(); // ã‚¸ãƒ£ãƒ³ãƒ—ã¯ãã®ã¾ã¾
      touchStartX = null; touchStartY = null;
    }, { passive: true });

    window.addEventListener('resize', () => {
      // â˜…â˜…â˜… ãƒªã‚µã‚¤ã‚ºæ™‚ã‚‚ gameContainer ã®å¹…ã‚’åŸºæº–ã« characterX ã‚’å†è¨ˆç®—ãƒ»åˆ¶é™ â˜…â˜…â˜…
      characterX = gameContainer.offsetWidth / 2; // ä¸­å¤®ã«æˆ»ã™ã‹ã€ç¾åœ¨ã®æ¯”ç‡ã‚’ç¶­æŒã™ã‚‹ã‹
      const charWidth = character.offsetWidth || parseInt(getComputedStyle(character).width) || 120;
      characterX = Math.max(charWidth / 2, Math.min(gameContainer.offsetWidth - (charWidth / 2), characterX));
      updateCharacterPosition();
    });

    // updateCharacterPosition(); // åˆæœŸä½ç½®ã‚»ãƒƒãƒˆã¯ startGame å†…ã§è¡Œã†
    function attemptBgmPlay() { if (bgm && typeof bgm.play === 'function' && bgm.paused) { bgm.play().then(() => { document.body.removeEventListener('click', attemptBgmPlay); document.body.removeEventListener('touchstart', attemptBgmPlay); }).catch(error => { console.warn("BGMã®å†ç”Ÿè©¦è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ:", error); }); } else if (bgm && !bgm.paused) { document.body.removeEventListener('click', attemptBgmPlay); document.body.removeEventListener('touchstart', attemptBgmPlay); } }
    document.body.addEventListener('click', attemptBgmPlay, {once: true});
    document.body.addEventListener('touchstart', attemptBgmPlay, {once: true});

    startGame();
  </script>
</body>
</html>
